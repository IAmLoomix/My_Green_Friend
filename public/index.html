<!DOCTYPE html>
<html lang="ru" x-data="plantApp()" x-init="init()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø –ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥</title>

    <!-- favicon -->
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase -->
    <script src="./supabase-client.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS (–¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å—Ç–∏–ª–µ–π) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="./styles.css">
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container mx-auto px-4 py-6 max-w-2xl">

        <!-- –®–∞–ø–∫–∞ —Å –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
        <header class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <!-- –ë—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
                <button @click="toggleMenu($event)" class="burger-menu p-2 rounded-lg hover:bg-gray-100 transition"
                    :class="{'open': isMenuOpen}">
                    <div class="w-6 h-6 flex flex-col justify-between">
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                    </div>
                </button>

                <h1 class="text-3xl font-bold text-green-700">
                    <i class="fas fa-leaf mr-2"></i>
                    <span x-text="getPageTitle(currentPage)"></span>
                </h1>

                <div class="text-sm text-gray-600">
                    <span x-text="user ? user.first_name : '–ì–æ—Å—Ç—å'"></span>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π) -->
            <button x-show="currentPage === 'plants'" @click="showAddForm = true"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition">
                <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
            </button>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏) -->
            <div x-show="currentPage === 'encyclopedia'" class="mb-6">
                <div class="relative">
                    <input type="text" x-model="encyclopediaSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Å—Ç–µ–Ω–∏—è..."
                        class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </header>

        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
        <div class="sidebar-menu fixed inset-y-0 left-0 z-50 bg-white shadow-xl overflow-y-auto"
            :class="{'open': isMenuOpen}" @click.away="isMenuOpen = false">
            <div class="p-6">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-green-700">
                        <i class="fas fa-leaf mr-2"></i>–ú–µ–Ω—é
                    </h2>
                    <button @click="isMenuOpen = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="space-y-2">
                    <!-- –ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                    <button @click="changePage('plants')" :class="{'active-page': currentPage === 'plants'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-seedling mr-3 text-green-600"></i>
                        <div>
                            <div class="font-medium">–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</div>
                            <div class="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</div>
                        </div>
                    </button>

                    <!-- –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è -->
                    <button @click="changePage('encyclopedia')" :class="{'active-page': currentPage === 'encyclopedia'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-book mr-3 text-purple-600"></i>
                        <div>
                            <div class="font-medium">–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è</div>
                            <div class="text-sm text-gray-500">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö</div>
                        </div>
                    </button>

                    <!-- –ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–Ω–π—Å -->
                    <button @click="changePage('marketplace')" :class="{'active-page': currentPage === 'marketplace'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-shopping-cart mr-3 text-blue-600"></i>
                        <div>
                            <div class="font-medium">–ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</div>
                            <div class="text-sm text-gray-500">–ü–æ—á–≤–∞, —É–¥–æ–±—Ä–µ–Ω–∏—è –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
                        </div>
                    </button>

                    <!-- –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ -->
                    <button @click="changePage('lightmeter')" :class="{'active-page': currentPage === 'lightmeter'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-sun mr-3 text-yellow-600"></i>
                        <div>
                            <div class="font-medium">–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏</div>
                            <div class="text-sm text-gray-500">–ò–∑–º–µ—Ä—å—Ç–µ —Å–≤–µ—Ç –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                        </div>
                    </button>

                    <!-- –î–æ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                    <button @click="changePage('doctor')" :class="{'active-page': currentPage === 'doctor'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-stethoscope mr-3 text-red-600"></i>
                        <div>
                            <div class="font-medium">–î–æ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                            <div class="text-sm text-gray-500">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –∏ –ª–µ—á–µ–Ω–∏–µ</div>
                        </div>
                    </button>

                    <!-- –ß–∞—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤ -->
                    <button @click="changePage('gardeners_chat')"
                        :class="{'active-page': currentPage === 'gardeners_chat'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fab fa-telegram mr-3 text-blue-500"></i>
                        <div>
                            <div class="font-medium">–ß–∞—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤</div>
                            <div class="text-sm text-gray-500">–û–±—â–µ–Ω–∏–µ –≤ Telegram</div>
                        </div>
                    </button>
                </div>

                <div class="mt-12 pt-6 border-t border-gray-200">
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="text-4xl">üåø</div>
                            <div class="text-lg font-bold text-green-700 mt-2">–ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥</div>
                        </div>
                        <p class="text-sm text-gray-500">–®–∫–æ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç "–ü–æ–ª—ë—Ç"</p>
                        <p class="text-xs text-gray-400 mt-2">–í–µ—Ä—Å–∏—è 0.9.0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é -->
        <div x-show="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü -->
        <div class="page-transition">
            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è" -->
            <div x-show="currentPage === 'plants'">
                <!-- –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div x-show="notificationStatus" class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                    <div class="flex items-center">
                        <i class="fas fa-bell text-blue-500 mr-3 text-lg"></i>
                        <div>
                            <p class="font-medium text-blue-800" x-text="notificationStatus"></p>
                            <p class="text-sm text-blue-600 mt-1">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 10:00</p>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                <div x-show="!loading && plants.length > 0" class="mb-10">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">–í—Å–µ —Ä–∞—Å—Ç–µ–Ω–∏—è (<span
                            x-text="plants.length"></span>)</h2>

                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="flex space-x-2 mb-4">
                        <button @click="filter = 'all'"
                            :class="filter === 'all' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –í—Å–µ
                        </button>
                        <button @click="filter = 'today'"
                            :class="filter === 'today' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è
                        </button>
                        <button @click="filter = 'tomorrow'"
                            :class="filter === 'tomorrow' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –ó–∞–≤—Ç—Ä–∞
                        </button>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                    <div class="space-y-4">
                        <template x-for="plant in filteredPlants" :key="plant.id">
                            <div class="plant-card bg-white rounded-xl shadow-sm p-4 border border-gray-200"
                                :class="{'border-red-300 urgent': plant.days_until <= 0}">

                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800" x-text="plant.custom_name"></h3>
                                        <p class="text-gray-600 text-sm" x-text="plant.species_name"></p>
                                    </div>

                                    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–ª–∏–≤–∞ -->
                                    <div class="text-right">
                                        <span class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                                            :class="getWateringStatusClass(plant)">
                                            <span x-text="getWateringStatusText(plant)"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ -->
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <p class="text-gray-500">–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞</p>
                                        <p class="font-medium" x-text="plant.watering_days + ' –¥–Ω–µ–π'"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</p>
                                        <p class="font-medium" x-text="formatDate(plant.last_watered)"></p>
                                    </div>
                                </div>

                                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–ª–∏–≤–∞ -->
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª–∏–≤–∞</span>
                                        <span x-text="plant.days_passed + '/' + plant.watering_days + ' –¥–Ω–µ–π'"></span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500 rounded-full transition-all duration-500"
                                            :style="'width: ' + plant.watering_progress + '%'"></div>
                                    </div>
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                <div class="flex space-x-2">
                                    <button @click="waterPlant(plant.id)"
                                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center transition">
                                        <i class="fas fa-tint mr-2"></i>–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                                    </button>
                                    <button @click="showPlantDetails(plant.id)"
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                        <i class="fas fa-info"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                <div x-show="!loading && plants.length === 0" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-seedling text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π</h3>
                    <p class="text-gray-500 mb-6">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ, –∏ –º—ã –Ω–∞–ø–æ–º–Ω–∏–º –∫–æ–≥–¥–∞ –µ–≥–æ –ø–æ–ª–∏–≤–∞—Ç—å</p>
                    <button @click="showAddForm = true"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg">
                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
                    </button>
                    <button @click="addDemoPlants()"
                        class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è
                    </button>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è" -->
            <div x-show="currentPage === 'encyclopedia'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π (<span x-text="filteredEncyclopedia.length"></span> –≤–∏–¥–æ–≤)
                    </h2>
                    <p class="text-gray-600 mb-4">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∏–¥–∞—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π, —É—Å–ª–æ–≤–∏—è—Ö –∏—Ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏ —É—Ö–æ–¥–µ
                    </p>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
                <div class="plant-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <template x-for="plant in filteredEncyclopedia" :key="plant.id">
                        <button @click="showEncyclopediaDetail(plant)"
                            class="encyclopedia-plant-card p-3 bg-gray-50 hover:bg-green-50 rounded-lg text-left transition">
                            <div class="font-medium text-gray-800 text-sm truncate" x-text="plant.name"></div>
                            <div class="text-xs text-gray-500 mt-1 truncate">
                                –ü–æ–ª–∏–≤ –∫–∞–∂–¥—ã–µ <span x-text="plant.watering_days"></span> –¥–Ω–µ–π
                            </div>
                            <div class="text-xs text-gray-400 mt-2 line-clamp-2" x-text="plant.description || ''"></div>
                        </button>
                    </template>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ -->
                <div x-show="encyclopediaSearch && filteredEncyclopedia.length === 0" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-search text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞</p>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" -->
            <div x-show="currentPage === 'marketplace'">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-shopping-cart text-blue-600 mr-2"></i>–ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
                    </h2>
                    <p class="text-gray-600 mb-4">–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —É—Ö–æ–¥–∞ –∑–∞ –≤–∞—à–∏–º–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</p>

                    <div class="relative mb-6">
                        <input type="text" x-model="marketplaceSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."
                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button @click="marketplaceFilter = 'all'"
                            :class="marketplaceFilter === 'all' ? 'bg-blue-100 text-blue-800 border-blue-300' : 'bg-gray-100 text-gray-800 border-gray-300'"
                            class="px-3 py-1 rounded-full text-sm font-medium border transition">
                            –í—Å–µ —Ç–æ–≤–∞—Ä—ã
                        </button>
                        <button @click="marketplaceFilter = 'soil'"
                            :class="marketplaceFilter === 'soil' ? 'bg-green-100 text-green-800 border-green-300' : 'bg-gray-100 text-gray-800 border-gray-300'"
                            class="px-3 py-1 rounded-full text-sm font-medium border transition">
                            <i class="fas fa-tree mr-1"></i>–ì—Ä—É–Ω—Ç
                        </button>
                        <button @click="marketplaceFilter = 'fertilizer'"
                            :class="marketplaceFilter === 'fertilizer' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-gray-100 text-gray-800 border-gray-300'"
                            class="px-3 py-1 rounded-full text-sm font-medium border transition">
                            <i class="fas fa-flask mr-1"></i>–£–¥–æ–±—Ä–µ–Ω–∏—è
                        </button>
                        <button @click="marketplaceFilter = 'pot'"
                            :class="marketplaceFilter === 'pot' ? 'bg-purple-100 text-purple-800 border-purple-300' : 'bg-gray-100 text-gray-800 border-gray-300'"
                            class="px-3 py-1 rounded-full text-sm font-medium border transition">
                            <i class="fas fa-utensils mr-1"></i>–ì–æ—Ä—à–∫–∏
                        </button>
                        <button @click="marketplaceFilter = 'accessory'"
                            :class="marketplaceFilter === 'accessory' ? 'bg-red-100 text-red-800 border-red-300' : 'bg-gray-100 text-gray-800 border-gray-300'"
                            class="px-3 py-1 rounded-full text-sm font-medium border transition">
                            <i class="fas fa-toolbox mr-1"></i>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã
                        </button>
                    </div>
                </div>

                <div x-show="marketplaceFilter.startsWith('related-') && relatedProductsFilter"
                    class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-blue-800">
                                <i class="fas fa-link mr-2"></i>
                                –¢–æ–≤–∞—Ä—ã –¥–ª—è: <span x-text="getPlantNameById(relatedProductsFilter)"></span>
                            </p>
                            <p class="text-sm text-blue-600 mt-1">
                                –ü–æ–∫–∞–∑–∞–Ω–æ <span x-text="filteredMarketplaceProducts.length"></span> —Ç–æ–≤–∞—Ä–æ–≤
                            </p>
                        </div>
                        <button @click="clearRelatedFilter()"
                            class="text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-300 rounded-lg text-sm">
                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
                        </button>
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div x-show="!loadingMarketplace && filteredMarketplaceProducts.length > 0"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="product in filteredMarketplaceProducts" :key="product.id">
                        <div
                            class="bg-white rounded-xl shadow-sm p-4 border border-gray-200 hover:shadow-md transition">
                            <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
                            <div
                                class="mb-3 h-40 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                                <template x-if="product.image_url">
                                    <img :src="product.image_url" :alt="product.name"
                                        class="w-full h-full object-cover">
                                </template>
                                <template x-if="!product.image_url">
                                    <div class="text-gray-400 text-4xl">
                                        <i :class="getProductIcon(product.category)"></i>
                                    </div>
                                </template>
                            </div>

                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
                            <h3 class="font-bold text-gray-800 text-sm mb-2" x-text="product.name"></h3>
                            <div class="mb-2">
                                <span class="inline-block px-2 py-1 text-xs rounded-full"
                                    :class="getCategoryClass(product.category)">
                                    <span x-text="getCategoryName(product.category)"></span>
                                </span>
                            </div>

                            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                            <p class="text-gray-600 text-xs mb-3 line-clamp-2" x-text="product.description"></p>

                            <!-- –¶–µ–Ω–∞ -->
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-bold text-blue-700"
                                    x-text="product.price_range || '–¶–µ–Ω–∞ –ø–æ —Å—Å—ã–ª–∫–µ'"></span>
                                <span class="text-xs text-gray-500" x-text="product.tags?.join(', ') || ''"></span>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ -->
                            <a :href="product.external_url" target="_blank"
                                class="block w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white text-center font-medium py-2 px-4 rounded-lg transition transform hover:scale-[1.02]">
                                <i class="fas fa-external-link-alt mr-2"></i>–ö—É–ø–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
                            </a>

                            <!-- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                            <div x-show="product.attached_to_plants && product.attached_to_plants.length > 0"
                                class="mt-3 pt-3 border-t border-gray-100">
                                <p class="text-xs text-gray-500 mb-1">–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:</p>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="plantId in product.attached_to_plants.slice(0, 3)" :key="plantId">
                                        <span class="px-2 py-1 bg-green-50 text-green-700 text-xs rounded">
                                            <span x-text="getPlantNameById(plantId)"></span>
                                        </span>
                                    </template>
                                    <span x-show="product.attached_to_plants.length > 3"
                                        class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">
                                        +<span x-text="product.attached_to_plants.length - 3"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div x-show="!loadingMarketplace && filteredMarketplaceProducts.length === 0" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-shopping-cart text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</p>
                </div>

                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                <div x-show="loadingMarketplace" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600">
                    </div>
                    <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...</p>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏" -->
            <div x-show="currentPage === 'lightmeter'">
                <div class="light-meter-card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-2">
                        <i class="fas fa-sun mr-2 text-yellow-400"></i>–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    </h2>
                    <p class="text-gray-300 mb-6">
                        –ü–æ–ª–æ–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä—è–¥–æ–º —Å —Ä–∞—Å—Ç–µ–Ω–∏–µ–º
                    </p>

                    <button @click="measureLight()" :disabled="lightLoading"
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed">
                        <i class="fas fa-camera mr-2"></i>–ò–∑–º–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
                    </button>

                    <template x-if="lightLoading">
                        <div class="mt-8 text-center">
                            <div class="light-meter-loader"></div>
                            <p class="text-gray-300 mt-4">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–µ‚Ä¶</p>
                            <p class="text-sm text-gray-400">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ</p>
                        </div>
                    </template>

                    <template x-if="lightResult">
                        <div class="mt-8 light-result-card p-5">
                            <div class="flex items-center justify-between mb-4">
                                <span class="light-badge" :style="`background: ${lightResult.color}`"
                                    x-text="lightResult.label"></span>
                                <button @click="lightResult = null" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="space-y-3">
                                <div>
                                    <h3 class="font-medium text-white mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</h3>
                                    <p class="text-gray-300" x-text="lightResult.description"></p>
                                </div>

                                <div>
                                    <h3 class="font-medium text-white mb-1">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è:</h3>
                                    <p class="text-gray-300" x-text="lightResult.plants"></p>
                                </div>

                                <div class="pt-4 border-t border-gray-700">
                                    <h3 class="font-medium text-white mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3>
                                    <ul class="text-sm text-gray-300 space-y-1">
                                        <template x-if="lightResult.label === '–û—á–µ–Ω—å —Ç–µ–º–Ω–æ'">
                                            <li>‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</li>
                                        </template>
                                        <template x-if="lightResult.label === '–¢—É—Å–∫–ª–æ'">
                                            <li>‚Ä¢ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–°—Ä–µ–¥–Ω–µ'">
                                            <li>‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–Ø—Ä–∫–æ'">
                                            <li>‚Ä¢ –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–û—á–µ–Ω—å —è—Ä–∫–æ'">
                                            <li>‚Ä¢ –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ –ø–æ–ª–¥–µ–Ω—å</li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div class="mt-6 text-center text-sm text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤–µ—Ç–∞, –∞ –Ω–µ —è—Ä–∫–æ—Å—Ç—å –∫–∞–º–µ—Ä—ã
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–∞—Ö –æ—Å–≤–µ—â–µ–Ω–∏—è -->
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>–¢–∏–ø—ã –æ—Å–≤–µ—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏–π
                    </h3>

                    <div class="grid grid-cols-1 gap-4">
                        <!-- –û—á–µ–Ω—å —Ç–µ–º–Ω–æ -->
                        <div class="flex flex-col sm:flex-row sm:items-start">
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-3">
                                <div class="w-3 h-3 rounded-full bg-gray-500 flex-shrink-0"></div>
                                <h4 class="font-medium text-gray-700 ml-2 sm:ml-0 sm:hidden">–û—á–µ–Ω—å —Ç–µ–º–Ω–æ</h4>
                            </div>
                            <div class="sm:flex-1">
                                <h4 class="font-medium text-gray-700 hidden sm:block">–û—á–µ–Ω—å —Ç–µ–º–Ω–æ</h4>
                                <p class="text-sm text-gray-600">–¢–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º—ã—Ö —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (—Å–∞–Ω—Å–µ–≤–∏–µ—Ä–∏—è,
                                    –∑–∞–º–∏–æ–∫—É–ª—å–∫–∞—Å)</p>
                            </div>
                        </div>

                        <!-- –¢—É—Å–∫–ª–æ -->
                        <div class="flex flex-col sm:flex-row sm:items-start">
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-3">
                                <div class="w-3 h-3 rounded-full bg-gray-400 flex-shrink-0"></div>
                                <h4 class="font-medium text-gray-700 ml-2 sm:ml-0 sm:hidden">–¢—É—Å–∫–ª–æ</h4>
                            </div>
                            <div class="sm:flex-1">
                                <h4 class="font-medium text-gray-700 hidden sm:block">–¢—É—Å–∫–ª–æ</h4>
                                <p class="text-sm text-gray-600">–î–ª—è —Ç–µ–Ω–µ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (–ø–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫–∏, —Ñ–∏–ª–æ–¥–µ–Ω–¥—Ä–æ–Ω—ã)
                                </p>
                            </div>
                        </div>

                        <!-- –°—Ä–µ–¥–Ω–µ -->
                        <div class="flex flex-col sm:flex-row sm:items-start">
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-3">
                                <div class="w-3 h-3 rounded-full bg-yellow-400 flex-shrink-0"></div>
                                <h4 class="font-medium text-gray-700 ml-2 sm:ml-0 sm:hidden">–°—Ä–µ–¥–Ω–µ</h4>
                            </div>
                            <div class="sm:flex-1">
                                <h4 class="font-medium text-gray-700 hidden sm:block">–°—Ä–µ–¥–Ω–µ</h4>
                                <p class="text-sm text-gray-600">–ü–æ–¥—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</p>
                            </div>
                        </div>

                        <!-- –Ø—Ä–∫–æ -->
                        <div class="flex flex-col sm:flex-row sm:items-start">
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-3">
                                <div class="w-3 h-3 rounded-full bg-yellow-500 flex-shrink-0"></div>
                                <h4 class="font-medium text-gray-700 ml-2 sm:ml-0 sm:hidden">–Ø—Ä–∫–æ</h4>
                            </div>
                            <div class="sm:flex-1">
                                <h4 class="font-medium text-gray-700 hidden sm:block">–Ø—Ä–∫–æ</h4>
                                <p class="text-sm text-gray-600">–î–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (—Å—É–∫–∫—É–ª–µ–Ω—Ç—ã, —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ)</p>
                            </div>
                        </div>

                        <!-- –û—á–µ–Ω—å —è—Ä–∫–æ -->
                        <div class="flex flex-col sm:flex-row sm:items-start">
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-3">
                                <div class="w-3 h-3 rounded-full bg-red-400 flex-shrink-0"></div>
                                <h4 class="font-medium text-gray-700 ml-2 sm:ml-0 sm:hidden">–û—á–µ–Ω—å —è—Ä–∫–æ</h4>
                            </div>
                            <div class="sm:flex-1">
                                <h4 class="font-medium text-gray-700 hidden sm:block">–û—á–µ–Ω—å —è—Ä–∫–æ</h4>
                                <p class="text-sm text-gray-600">–ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ —Å–∞–º—ã–µ —Å–æ–ª–Ω–µ—á–Ω—ã–µ —á–∞—Å—ã
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–î–æ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π" -->
            <div x-show="currentPage === 'doctor'">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-stethoscope text-red-600 mr-2"></i>–î–æ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π
                    </h2>
                    <p class="text-gray-600 mb-4">–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã</p>
                </div>

                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –Ω–∞—á–∞–ª–æ -->
                <div x-show="!currentQuestion && !diagnosisResult" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-seedling text-5xl text-green-400"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–ù–∞—á–Ω–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</h3>
                    <p class="text-gray-500 mb-6">–ú—ã –∑–∞–¥–∞–¥–∏–º 3-5 –≤–æ–ø—Ä–æ—Å–æ–≤ —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É</p>
                    <button @click="startDiagnosis()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg">
                        –ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                    </button>
                </div>

                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: –≤–æ–ø—Ä–æ—Å -->
                <div x-show="currentQuestion && !diagnosisResult">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>–í–æ–ø—Ä–æ—Å <span x-text="currentQuestionNumber"></span></span>
                            <span>~ –æ—Å—Ç–∞–ª–æ—Å—å <span x-text="estimatedQuestionsLeft"></span></span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full transition-all duration-300"
                                :style="'width: ' + diagnosisProgress + '%'"></div>
                        </div>
                    </div>

                    <!-- –í–æ–ø—Ä–æ—Å -->
                    <div class="mb-6 p-5 bg-white rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" x-show="currentQuestion">
                            <span x-text="currentQuestionNumber"></span>.
                            <span
                                x-text="currentQuestion ? currentQuestion.question_text : '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...'"></span>
                        </h3>

                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
                        <div class="space-y-3" x-show="currentQuestionAnswers && currentQuestionAnswers.length > 0">
                            <template x-for="answer in currentQuestionAnswers" :key="answer.id">
                                <button @click="selectAnswer(answer)"
                                    class="w-full p-4 text-left bg-gray-50 hover:bg-green-50 border border-gray-300 hover:border-green-400 rounded-lg transition group">
                                    <div class="font-medium text-gray-800" x-text="answer.answer_text"></div>
                                    <div
                                        class="mt-1 text-sm text-gray-500 opacity-0 group-hover:opacity-100 transition">
                                        –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ ‚Üí
                                    </div>
                                </button>
                            </template>
                        </div>

                        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ -->
                        <div x-show="currentQuestion && (!currentQuestionAnswers || currentQuestionAnswers.length === 0)"
                            class="text-center py-4 text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤...
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
                    <button x-show="questionHistory.length > 0" @click="goBack()"
                        class="text-gray-600 hover:text-gray-800 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                    </button>
                </div>

                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div x-show="diagnosisResult" class="page-transition">
                    <div class="text-center mb-8">
                        <div
                            class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-100 text-red-600 mb-4">
                            <i class="fas fa-stethoscope text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
                        <p class="text-gray-600">–í–æ—Ç —á—Ç–æ –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏:</p>
                    </div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6"
                        x-show="diagnosisResult && diagnosisResult.recommendation_text">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clipboard-check text-green-600 mr-2"></i>–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ:
                        </h4>
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-gray-800 leading-relaxed preserve-linebreaks"
                                x-text="diagnosisResult && diagnosisResult.recommendation_text ? diagnosisResult.recommendation_text : '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞...'">
                            </p>
                        </div>
                    </div>

                    <!-- –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ—à–∏–±–∫–∞) -->
                    <div x-show="diagnosisResult && !diagnosisResult.recommendation_text"
                        class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-yellow-800 mb-4 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
                        </h4>
                        <p class="text-yellow-700">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ.</p>
                        <button @click="startNewDiagnosis()"
                            class="mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg">
                            –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                        </button>
                    </div>


                    <!-- –û–±—â–∏–µ —Å–æ–≤–µ—Ç—ã -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-5 mb-6">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
                        </h4>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-start">
                                <i class="fas fa-tint text-blue-500 mt-1 mr-2"></i>
                                <span>–ü–æ–ª–∏–≤–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π –ø–æ—á–≤—ã –ø—Ä–æ—Å–æ—Ö –Ω–∞ 2-3 —Å–º</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-sun text-blue-500 mt-1 mr-2"></i>
                                <span>–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤—É —Ä–∞—Å—Ç–µ–Ω–∏–π –Ω—É–∂–µ–Ω —è—Ä–∫–∏–π —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–π —Å–≤–µ—Ç</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-wind text-blue-500 mt-1 mr-2"></i>
                                <span>–ò–∑–±–µ–≥–∞–π—Ç–µ —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤ –∏ —Ä–µ–∑–∫–∏—Ö –ø–µ—Ä–µ–ø–∞–¥–æ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-spa text-blue-500 mt-1 mr-2"></i>
                                <span>–£–¥–æ–±—Ä—è–π—Ç–µ –≤ –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ (–≤–µ—Å–Ω–∞-–ª–µ—Ç–æ)</span>
                            </li>
                        </ul>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="flex space-x-3">
                        <button @click="startNewDiagnosis()"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition">
                            <i class="fas fa-redo mr-2"></i>–ù–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                        </button>
                        <button @click="currentPage = 'encyclopedia'"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition">
                            <i class="fas fa-book mr-2"></i>–í —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ß–∞—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤ -->
            <div x-show="currentPage === 'gardeners_chat'">
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                        <div class="mb-6">
                            <div class="text-6xl mb-4">üå±</div>
                            <h1 class="text-2xl font-bold text-gray-800 mb-2">–ß–∞—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤</h1>
                            <p class="text-gray-600">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É Telegram-—á–∞—Ç—É –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏
                                —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–∞–º–∏</p>
                        </div>

                        <a href="https://t.me/My_Green_Friend_Plantgrowers/" target="_blank"
                            class="inline-flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition duration-300 w-full">
                            <i class="fab fa-telegram text-xl mr-3"></i>
                            –ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram-—á–∞—Ç
                        </a>

                        <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-blue-800 mb-2">–ß—Ç–æ –≤ —á–∞—Ç–µ?</h3>
                            <ul class="text-sm text-blue-700 text-left space-y-1">
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                    <span>–°–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                    <span>–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç –æ–ø—ã—Ç–Ω—ã—Ö —Å–∞–¥–æ–≤–æ–¥–æ–≤</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                    <span>–û–±–º–µ–Ω —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏ –∏ —Å–µ–º–µ–Ω–∞–º–∏</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                                    <span>–§–æ—Ç–æ –≤–∞—à–∏—Ö –∑–µ–ª—ë–Ω—ã—Ö –¥—Ä—É–∑–µ–π</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü) -->
        <div x-show="loading === true" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-600">
            </div>
            <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è -->
        <div x-show="showAddForm"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">–ù–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</h2>
                        <button @click="showAddForm = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <form @submit.prevent="addNewPlant">
                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                        <div class="mb-5">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-tag mr-2"></i>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                            </label>
                            <input type="text" x-model="newPlant.custom_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –ª—é–±–∏–º—ã–π —Ñ–∏–∫—É—Å"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                        </div>

                        <!-- –í—ã–±–æ—Ä –≤–∏–¥–∞ -->
                        <div class="mb-5">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-seedling mr-2"></i>–í–∏–¥ —Ä–∞—Å—Ç–µ–Ω–∏—è
                            </label>
                            <div class="relative">
                                <select x-model="newPlant.species_id" required
                                    @change="onSpeciesChange($event.target.value)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg appearance-none focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition bg-white">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞—Å—Ç–µ–Ω–∏—è</option>
                                    <template x-for="species in plantSpecies" :key="species.id">
                                        <option :value="species.id"
                                            x-text="species.name + ' (–ø–æ–ª–∏–≤ –∫–∞–∂–¥—ã–µ ' + species.watering_days + ' –¥–Ω–µ–π)'">
                                        </option>
                                    </template>
                                </select>
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>

                            <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ -->
                            <div x-show="selectedSpecies && selectedSpecies.description"
                                class="mt-3 p-3 bg-green-50 rounded-lg">
                                <p class="text-sm text-green-800" x-text="selectedSpecies?.description || ''">
                                </p>
                                <p class="text-sm font-medium text-green-900 mt-1">
                                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–ª–∏–≤: –∫–∞–∂–¥—ã–µ
                                    <span x-text="selectedSpecies?.watering_days || '?'"></span> –¥–Ω–µ–π
                                </p>
                            </div>
                        </div>

                        <!-- –ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å) -->
                        <div class="mb-5">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-calendar-alt mr-2"></i>–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞ (–¥–Ω–µ–π)
                            </label>
                            <input type="number" x-model="newPlant.watering_days" min="1" max="30" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                            <p class="text-sm text-gray-500 mt-2">–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏</p>
                        </div>

                        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-sticky-note mr-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                            </label>
                            <textarea x-model="newPlant.notes" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç–æ–∏—Ç –Ω–∞ –∫—É—Ö–æ–Ω–Ω–æ–º –æ–∫–Ω–µ"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition resize-none"></textarea>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="flex space-x-3">
                            <button type="button" @click="showAddForm = false"
                                class="flex-1 py-3 px-4 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="submit" :disabled="addingPlant"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!addingPlant">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ</span>
                                <span x-show="addingPlant">–î–æ–±–∞–≤–ª—è–µ–º...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Å—Ç–µ–Ω–∏—è -->
        <div x-show="showDetailsModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800" x-text="selectedPlant.custom_name">
                            </h2>
                            <p class="text-gray-600" x-text="selectedPlant.species_name"></p>
                        </div>
                        <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="space-y-4 mb-6">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤</span>
                                <span class="font-medium" :class="getTextColor(selectedPlant.days_until)"
                                    x-text="getNextWateringText(selectedPlant)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</span>
                                <span class="font-medium" x-text="formatDate(selectedPlant.last_watered)"></span>
                            </div>
                        </div>

                        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
                        <div x-show="selectedPlant.notes" class="p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-medium text-blue-800 mb-1"><i class="fas fa-sticky-note mr-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
                            </h4>
                            <p class="text-blue-900" x-text="selectedPlant.notes"></p>
                        </div>
                    </div>

                    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–∏–≤–æ–≤ -->
                    <template x-if="wateringHistory && wateringHistory.length > 0">
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-700 mb-3"><i class="fas fa-history mr-2"></i>–ò—Å—Ç–æ—Ä–∏—è
                                –ø–æ–ª–∏–≤–æ–≤</h4>
                            <div class="space-y-2">
                                <template x-for="record in wateringHistory" :key="record.id">
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-tint text-blue-500 mr-3"></i>
                                        <span class="text-gray-600" x-text="formatDate(record.watered_date)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="pt-4 border-t border-gray-200">
                        <div class="flex space-x-2">
                            <button @click="waterPlant(selectedPlant.id); showDetailsModal = false;"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition">
                                <i class="fas fa-tint mr-2"></i>–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                            </button>
                            <button @click="deletePlant(selectedPlant.id)"
                                class="px-4 py-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <!-- –ö–Ω–æ–ø–∫–∞ –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è -->
                        <button @click="showEncyclopediaDetailFromPlant(selectedPlant.species_name)"
                            class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition">
                            <i class="fas fa-book mr-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                        </button>
                        <button @click="showRelatedProducts(selectedPlant.species_id)"
                            class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition">
                            <i class="fas fa-shopping-cart mr-2"></i>–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
        <div x-show="showEncyclopediaModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div
                class="bg-white encyclopedia-modal w-full max-w-2xl max-h-[90vh] overflow-hidden rounded-2xl shadow-xl">
                <div class="p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                            <i class="fas fa-book text-purple-500 mr-2"></i>–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π
                        </h2>
                        <button @click="showEncyclopediaModal = false" class="text-gray-400 hover:text-gray-600 p-1">
                            <i class="fas fa-times text-xl sm:text-2xl"></i>
                        </button>
                    </div>

                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                    <div x-show="encyclopediaPlantName"
                        class="mb-4 sm:mb-6 p-3 sm:p-4 bg-gradient-to-r from-purple-50 to-green-50 rounded-xl border border-purple-100">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-800 truncate"
                            x-text="encyclopediaPlantName || '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ'"></h3>
                        <p class="text-gray-600 text-sm mt-1">–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ö–æ–¥–µ</p>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
                    <div class="encyclopedia-content">
                        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–∏ -->
                        <div x-show="currentPlantInfo" class="mb-6">
                            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
                            <div class="plant-info-card p-4 sm:p-5 rounded-lg mb-4">
                                <div class="info-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                                    <div class="space-y-2">
                                        <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                            <i class="fas fa-seedling mr-2 text-sm"></i>–û–ø–∏—Å–∞–Ω–∏–µ
                                        </h4>
                                        <p class="text-gray-700 text-sm sm:text-base"
                                            x-text="currentPlantInfo?.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'">
                                        </p>
                                    </div>
                                    <div class="space-y-2">
                                        <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                            <i class="fas fa-temperature-high mr-2 text-sm"></i>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–æ—Å–≤–µ—â–µ–Ω–∏–µ
                                        </h4>
                                        <p class="text-gray-700 text-sm sm:text-base"
                                            x-text="currentPlantInfo?.temperature || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'">
                                        </p>
                                    </div>
                                    <div class="space-y-2">
                                        <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                            <i class="fas fa-tint mr-2 text-sm"></i>–ü–æ–ª–∏–≤
                                        </h4>
                                        <p class="text-gray-700 text-sm sm:text-base"
                                            x-text="currentPlantInfo?.watering_details || currentPlantInfo?.watering || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'">
                                        </p>
                                    </div>
                                    <div class="space-y-2">
                                        <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                            <i class="fas fa-spa mr-2 text-sm"></i>–ü–æ–¥–∫–æ—Ä–º–∫–∞
                                        </h4>
                                        <p class="text-gray-700 text-sm sm:text-base"
                                            x-text="currentPlantInfo?.feeding || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'">
                                        </p>
                                    </div>
                                    <div class="md:col-span-2 space-y-2">
                                        <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                            <i class="fas fa-tree mr-2 text-sm"></i>–ü–æ—á–≤–∞
                                        </h4>
                                        <p class="text-gray-700 text-sm sm:text-base"
                                            x-text="currentPlantInfo?.soil || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –†—É–≤–∏–∫–∏ -->
                            <div x-show="currentPlantInfo?.wiki_url" class="mb-6">
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                    <h4 class="font-bold text-blue-800 text-sm sm:text-base mb-2 flex items-center">
                                        <i class="fas fa-external-link-alt mr-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –†—É–≤–∏–∫–∏
                                    </h4>
                                    <p class="text-blue-700 text-sm mb-3">–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç—å—è –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏ –≤ —Ä—É—Å—Å–∫–æ–π
                                        —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏</p>
                                    <a :href="currentPlantInfo?.wiki_url" target="_blank"
                                        class="wiki-link inline-flex items-center px-4 py-2 bg-white text-blue-600 rounded-lg font-medium hover:no-underline">
                                        <i class="fab fa-wikipedia-w mr-2"></i>
                                        <span>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é –≤ –†—É–≤–∏–∫–∏</span>
                                        <i class="fas fa-external-link-alt ml-2 text-sm"></i>
                                    </a>
                                    <button @click="openInBrowser(currentPlantInfo?.wiki_url)"
                                        class="wiki-link inline-flex items-center px-4 py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition cursor-pointer">
                                        <i class="fab fa-wikipedia-w mr-2"></i>
                                        <span>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é –≤ –†—É–≤–∏–∫–∏</span>
                                        <i class="fas fa-external-link-alt ml-2 text-sm"></i>
                                    </button>
                                    <p class="text-xs text-blue-500 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        –û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§—É—Ç–µ—Ä -->
        <footer class="mt-12 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
            <p>üåø –ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥ ‚Ä¢ –®–∫–æ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç "–ü–æ–ª—ë—Ç"</p>
            <p>–í–µ—Ä—Å–∏—è 0.9.0</p>
            <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 10:00</p>
            <p class="mt-2">–†–∞—Å—Ç–µ–Ω–∏–π –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏: <span x-text="plantEncyclopedia.length"></span> –≤–∏–¥–æ–≤
            </p>
        </footer>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script>
        function plantApp() {
            return {
                // –î–æ–±–∞–≤–ª—è–µ–º $nextTick –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                $nextTick: (fn) => setTimeout(fn, 0),

                // –ú–∞–≥–∞–∑–∏–Ω
                marketplaceProducts: [],
                marketplaceFilter: 'all',
                marketplaceSearch: '',
                loadingMarketplace: false,
                relatedProductsFilter: null,

                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                loading: true,
                user: null,
                plants: [],
                plantSpecies: [],
                wateringHistory: [],

                // –§–∏–ª—å—Ç—Ä—ã
                filter: 'all',

                // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                showAddForm: false,
                showDetailsModal: false,
                showEncyclopediaModal: false,

                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                currentPage: 'plants',
                isMenuOpen: false,

                // –ü–æ–∏—Å–∫ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                encyclopediaSearch: '',

                // –î–æ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π
                currentQuestion: null,
                currentQuestionAnswers: [],
                questionHistory: [],
                diagnosisResult: null,
                currentQuestionNumber: 1,
                diagnosisProgress: 0,

                // –î–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è
                newPlant: {
                    custom_name: '',
                    species_id: '',
                    watering_days: 7,
                    notes: ''
                },

                // –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                selectedPlant: {},
                selectedSpecies: null,

                // –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è
                encyclopediaPlantName: '',
                currentPlantInfo: null,
                plantEncyclopedia: [],

                // –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                lightLoading: false,
                lightResult: null,

                // –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                notificationStatus: '',

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                async init() {
                    console.log('üöÄ init() –≤—ã–∑–≤–∞–Ω');

                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
                    if (this._initializing) return;
                    this._initializing = true;

                    this.loading = true;
                    console.log('1. loading —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true');

                    try {
                        // 1. –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Supabase
                        console.log('‚è≥ –ñ–¥—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Supabase...');
                        await this.waitForSupabaseReady();

                        // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
                        console.log('2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é Telegram...');
                        this.initTelegram();

                        // 3. –°–û–ó–î–ê–ï–ú/–ü–†–û–í–ï–†–Ø–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–î
                        console.log('3. –°–æ–∑–¥–∞—é/–ø—Ä–æ–≤–µ—Ä—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î...');
                        await this.ensureUserExists();

                        // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        console.log('4. –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...');
                        await this.loadData();

                        // 5. –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î
                        console.log('5. –ó–∞–≥—Ä—É–∂–∞—é —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î...');
                        await this.loadEncyclopedia();

                        console.log('6. –ó–∞–≥—Ä—É–∂–∞—é —Ç–æ–≤–∞—Ä—ã –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞...');
                        await this.loadMarketplaceProducts();

                        console.log('üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!');

                    } catch (error) {
                        console.error('üí• –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                        this.notificationStatus = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è';
                    } finally {
                        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                        setTimeout(() => {
                            this.loading = false;
                            console.log('‚úÖ loading —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ false');
                        }, 100);
                    }
                },

                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                changePage(page) {
                    console.log('üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:', page, '—Å —Ç–µ–∫—É—â–µ–π:', this.currentPage);

                    this.currentPage = page;
                    this.isMenuOpen = false;

                    // –°–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                    if (page === 'encyclopedia') {
                        this.encyclopediaSearch = '';
                    }

                    // –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    if (page === 'lightmeter') {
                        this.lightResult = null;
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π
                    if (page === 'plants') {
                        this.loadUserPlants();
                    }

                    // ‚Üì‚Üì‚Üì –í–ê–ñ–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ ‚Üì‚Üì‚Üì
                    if (page === 'marketplace') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ª–∏ –º—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é
                        const isFromMenuClick = !this.relatedProductsFilter;

                        if (isFromMenuClick) {
                            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ –º–µ–Ω—é - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                            console.log('üîÑ –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (–ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ –º–µ–Ω—é)');
                            this.marketplaceFilter = 'all';
                            this.marketplaceSearch = '';
                            this.relatedProductsFilter = null;
                        } else {
                            // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ —á–µ—Ä–µ–∑ "–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã" - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
                            console.log('üîó –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤:', this.relatedProductsFilter);
                        }
                    } else {
                        // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –õ–Æ–ë–£–Æ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                        // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                        if (this.relatedProductsFilter) {
                            console.log('üóëÔ∏è –°–±—Ä–æ—Å relatedProductsFilter –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:', page);
                            this.relatedProductsFilter = null;
                        }
                    }
                    if (page === 'gardeners_chat') {
                        console.log('üí¨ –û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤');
                    }
                },

                // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                getPageTitle(page) {
                    const titles = {
                        'plants': '–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è',
                        'encyclopedia': '–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è',
                        'marketplace': '–ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å',
                        'lightmeter': '–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏'
                    };
                    return titles[page] || '–ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥';
                },

                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–µ–Ω—é
                toggleMenu(event) {
                    event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                    this.isMenuOpen = !this.isMenuOpen;
                },

                // –ò–∑–º–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
                async measureLight() {
                    if (this.lightLoading) return;

                    this.lightLoading = true;
                    this.lightResult = null;

                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                        }

                        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: "environment",
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        });

                        const video = document.createElement("video");
                        video.srcObject = stream;
                        await video.play();

                        // –ñ–¥—ë–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏
                        await new Promise(r => setTimeout(r, 800));

                        const canvas = document.createElement("canvas");
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;

                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const stats = this.analyzeLight(imageData.data);
                        this.lightResult = this.classifyLight(stats);

                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                        stream.getTracks().forEach(track => track.stop());

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏:', error);

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        if (error.message.includes('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞') ||
                            error.message.includes('permission') ||
                            window.location.protocol === 'http:') {

                            // –î–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
                            const demoStats = {
                                brightRatio: 0.12,
                                darkRatio: 0.3,
                                contrast: 180
                            };
                            this.lightResult = this.classifyLight(demoStats);
                            this.notificationStatus = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º (–±–µ–∑ –∫–∞–º–µ—Ä—ã)';
                            setTimeout(() => this.notificationStatus = '', 3000);
                        } else {
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
                            setTimeout(() => this.notificationStatus = '', 3000);
                        }
                    } finally {
                        this.lightLoading = false;
                    }
                },

                // –ê–Ω–∞–ª–∏–∑ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                analyzeLight(data) {
                    let bright = 0;
                    let dark = 0;
                    let max = 0;
                    let min = 255;
                    const total = data.length / 4;

                    for (let i = 0; i < data.length; i += 4) {
                        const lum = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];

                        if (lum > 200) bright++;
                        if (lum < 40) dark++;

                        max = Math.max(max, lum);
                        min = Math.min(min, lum);
                    }

                    return {
                        brightRatio: bright / total,
                        darkRatio: dark / total,
                        contrast: max - min
                    };
                },

                // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                classifyLight(s) {
                    if (s.brightRatio < 0.02 && s.darkRatio > 0.6) {
                        return {
                            label: "–û—á–µ–Ω—å —Ç–µ–º–Ω–æ",
                            color: "#64748b",
                            description: "–û—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –†–∞—Å—Ç–µ–Ω–∏—è –±—É–¥—É—Ç —Å—Ç—Ä–∞–¥–∞—Ç—å –æ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å–≤–µ—Ç–∞.",
                            plants: "–¢–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º—ã—Ö —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö: —Å–∞–Ω—Å–µ–≤–∏–µ—Ä–∏—è, –∑–∞–º–∏–æ–∫—É–ª—å–∫–∞—Å"
                        };
                    }

                    if (s.brightRatio < 0.05) {
                        return {
                            label: "–¢—É—Å–∫–ª–æ",
                            color: "#94a3b8",
                            description: "–°–ª–∞–±–æ–µ —Ä–∞—Å—Å–µ—è–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ–Ω–µ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                            plants: "–ü–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫–∏, —Ñ–∏–ª–æ–¥–µ–Ω–¥—Ä–æ–Ω—ã, –∞–≥–ª–∞–æ–Ω–µ–º–∞"
                        };
                    }

                    if (s.brightRatio < 0.15) {
                        return {
                            label: "–°—Ä–µ–¥–Ω–µ",
                            color: "#facc15",
                            description: "–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–≤–µ—Ç–∞. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                            plants: "–§–∏–∫—É—Å—ã, –º–æ–Ω—Å—Ç–µ—Ä–∞, —Å–ø–∞—Ç–∏—Ñ–∏–ª–ª—É–º, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–ª–∏—Å—Ç–Ω—ã—Ö"
                        };
                    }

                    if (s.brightRatio < 0.35) {
                        return {
                            label: "–Ø—Ä–∫–æ",
                            color: "#fb923c",
                            description: "–•–æ—Ä–æ—à–æ –æ—Å–≤–µ—â—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                            plants: "–°—É–∫–∫—É–ª–µ–Ω—Ç—ã, –∫–∞–∫—Ç—É—Å—ã, —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ, –≥–∏–±–∏—Å–∫—É—Å"
                        };
                    }

                    return {
                        label: "–û—á–µ–Ω—å —è—Ä–∫–æ",
                        color: "#f97316",
                        description: "–û—á–µ–Ω—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Å–≤–µ—Ç. –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ —Å–∞–º—ã–µ —Å–æ–ª–Ω–µ—á–Ω—ã–µ —á–∞—Å—ã.",
                        plants: "–ü—É—Å—Ç—ã–Ω–Ω—ã–µ –∫–∞–∫—Ç—É—Å—ã, –∞–ª–æ—ç, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥—ã –∞–≥–∞–≤—ã"
                    };
                },

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É
                get filteredEncyclopedia() {
                    if (!this.encyclopediaSearch) {
                        return this.plantEncyclopedia;
                    }

                    const searchTerm = this.encyclopediaSearch.toLowerCase();
                    return this.plantEncyclopedia.filter(plant =>
                        plant.name.toLowerCase().includes(searchTerm) ||
                        (plant.description && plant.description.toLowerCase().includes(searchTerm))
                    );
                },

                // –ó–∞–≥—Ä—É–∑–∫–∞ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ –ë–î
                async loadEncyclopedia() {
                    try {
                        if (!window.supabase || typeof window.supabase.from !== 'function') {
                            console.error('‚ùå Supabase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏');
                            this.showAlert('–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                            return;
                        }

                        console.log('üìö –ó–∞–≥—Ä—É–∂–∞—é —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î...');

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã plant_species —Å –í–°–ï–ú–ò –ø–æ–ª—è–º–∏
                        const { data, error } = await window.supabase
                            .from('plant_species')
                            .select('*')
                            .order('name');

                        if (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏:', error);
                            this.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏! –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                            return;
                        }

                        if (data && data.length > 0) {
                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ: –µ—Å–ª–∏ –Ω–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π, –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                            this.plantEncyclopedia = data.map(plant => {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∞–ª–∏ –ø–æ–ª–∏–≤–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ
                                const wateringDetails = plant.watering_details ||
                                    plant.watering ||
                                    `—Ä–∞–∑ –≤ ${plant.watering_days} –¥–Ω–µ–π`;

                                return {
                                    ...plant,
                                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –µ—Å—Ç—å
                                    soil: plant.soil || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø–æ—á–≤–∞',
                                    temperature: plant.temperature || '+18‚Ä¶+25‚ÄØ¬∞C',
                                    watering_details: wateringDetails,
                                    feeding: plant.feeding || '1 —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –≤ –ø–µ—Ä–∏–æ–¥ —Ä–æ—Å—Ç–∞',
                                    wiki_url: plant.wiki_url || null
                                };
                            });
                            console.log(`‚úÖ –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –ë–î: ${data.length} —Ä–∞—Å—Ç–µ–Ω–∏–π`);
                        } else {
                            console.warn('‚ö†Ô∏è –í –ë–î –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏');
                            this.showAlert('–î–∞–Ω–Ω—ã—Ö –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                        }

                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏:', error);
                        this.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏\n ‚ãÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—É.\n ‚ãÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                    }
                },

                // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                showEncyclopediaDetail(plant) {
                    this.encyclopediaPlantName = plant.name;
                    this.currentPlantInfo = plant;
                    this.showEncyclopediaModal = true;
                },

                // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ —Ä–∞—Å—Ç–µ–Ω–∏—è
                showEncyclopediaDetailFromPlant(plantName) {
                    this.showDetailsModal = false;
                    this.encyclopediaPlantName = plantName;

                    // –ù–∞–π—Ç–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                    const plantInfo = this.plantEncyclopedia.find(p =>
                        p.name.toLowerCase().includes(plantName.toLowerCase()) ||
                        plantName.toLowerCase().includes(p.name.toLowerCase().split(' ')[0])
                    );

                    if (plantInfo) {
                        this.currentPlantInfo = plantInfo;
                        this.showEncyclopediaModal = true;
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —á–∞—Å—Ç—è–º
                        const searchTerms = plantName.toLowerCase().split(' ');
                        for (let term of searchTerms) {
                            if (term.length > 3) {
                                const found = this.plantEncyclopedia.find(p =>
                                    p.name.toLowerCase().includes(term)
                                );
                                if (found) {
                                    this.currentPlantInfo = found;
                                    this.showEncyclopediaModal = true;
                                    return;
                                }
                            }
                        }

                        // –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –Ω–∞—à–ª–∏
                        this.currentPlantInfo = {
                            name: plantName,
                            description: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Ç–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –Ω–∞—à—É —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é.',
                            soil: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                            temperature: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                            watering_details: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                            feeding: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                            wiki_url: null
                        };
                        this.showEncyclopediaModal = true;
                    }
                },

                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                showAlert(message) {
                    if (window.Telegram?.WebApp) {
                        Telegram.WebApp.showAlert(message);
                    } else {
                        this.notificationStatus = message;
                        setTimeout(() => this.notificationStatus = '', 3000);
                    }
                },

                // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ —á–µ—Ä–µ–∑ Telegram API –∏–ª–∏ –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä
                openInBrowser(url) {
                    if (!url) {
                        console.warn('URL –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω');
                        return;
                    }

                    console.log('üîÑ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É:', url);

                    // 1. –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram WebApp API
                    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.openLink) {
                        try {
                            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram.WebApp.openLink()');
                            Telegram.WebApp.openLink(url);
                            return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ Telegram API:', error);
                        }
                    }

                    // 2. Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback (window.open)');
                    window.open(url, '_blank', 'noopener,noreferrer');

                    // 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π fallback –¥–ª—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    if (!window.open) {
                        console.log('‚ö†Ô∏è window.open –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º location');
                        window.location.href = url;
                    }
                },

                // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                async ensureUserExists() {
                    console.log('–ü—Ä–æ–≤–µ—Ä—è—é/—Å–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î...');

                    if (!this.user || !this.user.id) {
                        console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }

                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ
                        const userData = {
                            telegram_id: this.user.id,
                            username: this.user.username || '',
                            first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            last_name: this.user.last_name || '',
                            created_at: new Date().toISOString()
                        };

                        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è UPSERT:', userData);

                        const { data, error } = await window.supabase
                            .from('users')
                            .upsert(userData, {
                                onConflict: 'telegram_id',
                                ignoreDuplicates: false
                            })
                            .select();

                        if (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ UPSERT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);

                            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –Ω–µ–≥–æ
                            if (error.message.includes('updated_at') || error.message.includes('column')) {
                                console.log('‚ö†Ô∏è –£–¥–∞–ª—è—é updated_at –∏–∑ –∑–∞–ø—Ä–æ—Å–∞...');
                                return await this.ensureUserExistsSimple();
                            }

                            if (error.code === '23505') { // unique_violation
                                console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                                return;
                            }

                            throw error;
                        }

                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î:', data);

                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ ensureUserExists:', error);
                    }
                },

                // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ updated_at
                async ensureUserExistsSimple() {
                    try {
                        const userData = {
                            telegram_id: this.user.id,
                            username: this.user.username || '',
                            first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            last_name: this.user.last_name || '',
                            created_at: new Date().toISOString()
                        };

                        console.log('–ü—Ä–æ–±—É—é –ø—Ä–æ—Å—Ç–æ–π UPSERT:', userData);

                        const { error } = await window.supabase
                            .from('users')
                            .upsert(userData, {
                                onConflict: 'telegram_id'
                            });

                        if (error) {
                            console.error('–ü—Ä–æ—Å—Ç–æ–π UPSERT —Ç–æ–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', error);

                            // –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –¥—É–±–ª–∏–∫–∞—Ç—ã
                            const { error: insertError } = await window.supabase
                                .from('users')
                                .insert(userData)
                                .select();

                            if (insertError && insertError.code !== '23505') {
                                console.error('–ò INSERT –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', insertError);
                            }
                        }

                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω');

                    } catch (error) {
                        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                    }
                },

                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
                /*
                 async createUserManually() {
                    if (!this.user) {
                        alert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }
 
                    try {
                        this.notificationStatus = '–°–æ–∑–¥–∞—é –ø—Ä–æ—Ñ–∏–ª—å...';
 
                        const userData = {
                            telegram_id: this.user.id,
                            username: this.user.username || '',
                            first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            last_name: this.user.last_name || '',
                            created_at: new Date().toISOString()
                        };
 
                        console.log('–°–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);
 
                        const { error } = await window.supabase
                            .from('users')
                            .insert([userData]);
 
                        if (error) {
                            console.error('–û—à–∏–±–∫–∞:', error);
                            alert(`–û—à–∏–±–∫–∞: ${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase.`);
                        } else {
                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!');
                            alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è.');
                            this.notificationStatus = '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω!';
                        }
                    } catch (error) {
                        console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', error);
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                },
                    */
                // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ:
                async waitForSupabaseReady() {
                    console.log('waitForSupabaseReady –≤—ã–∑–≤–∞–Ω–∞');
                    console.log('–¢–µ–∫—É—â–∏–π window.supabase:', window.supabase);
                    console.log('window.supabase.from:', typeof window.supabase?.from);

                    return new Promise((resolve) => {
                        let attempts = 0;
                        const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥

                        const check = () => {
                            attempts++;

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ supabase —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥ .from
                            if (window.supabase && typeof window.supabase.from === 'function') {
                                console.log(`‚úÖ Supabase –≥–æ—Ç–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ ${attempts})`);
                                resolve();
                                return;
                            }

                            if (attempts >= maxAttempts) {
                                console.warn(`‚ö†Ô∏è Supabase –Ω–µ –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
                                console.log('–°–æ–∑–¥–∞—é –∑–∞–≥–ª—É—à–∫—É...');
                                this.createSupabaseStub();
                                resolve();
                                return;
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
                            setTimeout(check, 100);
                        };

                        check();
                    });
                },

                // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ó–ê–ì–õ–£–®–ö–ò:
                createSupabaseStub() {
                    console.warn('–°–æ–∑–¥–∞—é –∑–∞–≥–ª—É—à–∫—É Supabase');

                    window.supabase = {
                        from: (table) => {
                            console.log(`[–ó–ê–ì–õ–£–®–ö–ê] –ó–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ: ${table}`);
                            return {
                                select: () => Promise.resolve({ data: [], error: null }),
                                insert: () => Promise.resolve({ data: [], error: null }),
                                update: () => Promise.resolve({ data: [], error: null }),
                                delete: () => Promise.resolve({ data: [], error: null }),
                                eq: () => ({ select: () => Promise.resolve({ data: [], error: null }) })
                            };
                        }
                    };

                    this.notificationStatus = '–†–µ–∂–∏–º –¥–µ–º–æ (–±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î)';
                },

                // –î–µ–º–æ —Ä–∞—Å—Ç–µ–Ω–∏—è:
                addDemoPlants() {
                    console.log('–î–æ–±–∞–≤–ª—è—é –¥–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è...');

                    const demoPlants = [
                        {
                            id: 1,
                            custom_name: '–§–∏–∫—É—Å –≤ –≥–æ—Å—Ç–∏–Ω–æ–π',
                            species_name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞',
                            watering_days: 7,
                            days_until: 2,
                            last_watered: '2024-03-12',
                            watering_progress: 71,
                            days_passed: 5
                        },
                        {
                            id: 2,
                            custom_name: '–ö–∞–∫—Ç—É—Å –Ω–∞ –æ–∫–Ω–µ',
                            species_name: '–ö–∞–∫—Ç—É—Å',
                            watering_days: 14,
                            days_until: 0,
                            last_watered: '2024-03-01',
                            watering_progress: 100,
                            days_passed: 14
                        },
                        {
                            id: 3,
                            custom_name: '–û—Ä—Ö–∏–¥–µ—è –≤ —Å–ø–∞–ª—å–Ω–µ',
                            species_name: '–û—Ä—Ö–∏–¥–µ—è –§–∞–ª–µ–Ω–æ–ø—Å–∏—Å',
                            watering_days: 5,
                            days_until: 1,
                            last_watered: '2024-03-10',
                            watering_progress: 80,
                            days_passed: 4
                        }
                    ];

                    this.plants = demoPlants;
                    this.notificationStatus = '–î–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã!';
                    setTimeout(() => this.notificationStatus = '', 3000);

                    console.log('–î–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã:', this.plants.length);
                },

                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                async registerUser() {
                    if (!this.user || !window.supabase) {
                        console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }

                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (this.user.id === 123456789) {
                        console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }

                    try {
                        console.log(`üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${this.user.id} –≤ –ë–î...`);

                        const { data, error } = await window.supabase
                            .from('users')
                            .upsert({
                                telegram_id: this.user.id,
                                username: this.user.username,
                                first_name: this.user.first_name,
                                last_name: this.user.last_name,
                                created_at: new Date().toISOString()
                            }, {
                                onConflict: 'telegram_id',
                                ignoreDuplicates: true // –û–ø—Ü–∏—è –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                            });

                        if (error) {
                            console.warn('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error.message);
                            // –ù–ï –ë–†–û–°–ê–ï–ú –û–®–ò–ë–ö–£ - —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        } else {
                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error.message);
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
                    }
                },

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
                initTelegram() {
                    console.log('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');

                    if (window.Telegram && Telegram.WebApp) {
                        console.log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                        Telegram.WebApp.ready();
                        Telegram.WebApp.expand();

                        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const userData = Telegram.WebApp.initDataUnsafe?.user;
                        console.log('initDataUnsafe.user:', userData);

                        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
                        const initData = Telegram.WebApp.initData;
                        console.log('initData —Å—Ç—Ä–æ–∫–∞:', initData);

                        if (userData && userData.id) {
                            this.user = {
                                id: userData.id,
                                username: userData.username,
                                first_name: userData.first_name,
                                last_name: userData.last_name
                            };
                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —á–µ—Ä–µ–∑ initDataUnsafe:', this.user);
                        } else {
                            // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å initData
                            try {
                                const params = new URLSearchParams(initData);
                                const userJson = params.get('user');
                                if (userJson) {
                                    const parsedUser = JSON.parse(decodeURIComponent(userJson));
                                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ parsed initData:', parsedUser);

                                    if (parsedUser.id) {
                                        this.user = {
                                            id: parsedUser.id,
                                            username: parsedUser.username,
                                            first_name: parsedUser.first_name,
                                            last_name: parsedUser.last_name
                                        };
                                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —á–µ—Ä–µ–∑ parsing:', this.user);
                                    }
                                }
                            } catch (parseError) {
                                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å initData:', parseError);
                            }

                            // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                            if (!this.user || !this.user.id) {
                                console.warn('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ Telegram WebApp');
                                console.log('Telegram.WebApp –æ–±—ä–µ–∫—Ç:', Telegram.WebApp);
                                console.log('Telegram –≤–µ—Ä—Å–∏—è:', Telegram.WebApp.version);

                                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                                this.notificationStatus = `–í–Ω–∏–º–∞–Ω–∏–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram –±–æ—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã.`;
                                setTimeout(() => this.notificationStatus = '', 60000); //–û–∂–∏–¥–∞–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ (—Ñ–æ—Ä–º—É–ª–∞: sec * 1000)

                                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram - –∑–∞–ø—Ä–æ—Å–∏–º ID —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                this.showUserIdPrompt();
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ –¥–µ–º–æ');
                        this.showUserIdPrompt();
                    }

                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', this.user);
                },

                // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                showUserIdPrompt() {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤ Telegram —ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
                    // –ù–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram –ø–æ–ª–µ–∑–Ω–æ

                    const testUserId = localStorage.getItem('test_user_id');
                    if (testUserId) {
                        this.user = {
                            id: parseInt(testUserId),
                            username: 'test_user',
                            first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                            last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        };
                        console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π ID:', this.user.id);
                    } else {
                        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        const userId = prompt(
                            '–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID (–∏–ª–∏ –ª—é–±–æ–π —á–∏—Å–ª–æ):\n\n' +
                            '–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789\n\n' +
                            '–≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π.',
                            '123456789'
                        );

                        if (userId) {
                            localStorage.setItem('test_user_id', userId);
                            this.user = {
                                id: parseInt(userId),
                                username: 'test_user',
                                first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                                last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                            };
                            console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π ID:', this.user.id);
                        } else {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
                            this.user = {
                                id: 123456789,
                                username: 'demo_user',
                                first_name: '–î–µ–º–æ',
                                last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                            };
                            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', this.user.id);
                        }
                    }
                },

                // –û–∂–∏–¥–∞–Ω–∏–µ Supabase
                async waitForSupabase() {
                    console.log('‚è≥ –û–∂–∏–¥–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Supabase...');

                    return new Promise((resolve, reject) => {
                        let attempts = 0;
                        const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

                        const check = () => {
                            attempts++;

                            if (window.supabase && typeof window.supabase.from === 'function') {
                                console.log(`‚úÖ Supabase –≥–æ—Ç–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ ${attempts})`);
                                resolve();
                                return;
                            }

                            if (attempts >= maxAttempts) {
                                console.error(`‚ùå Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
                                this.notificationStatus = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
                                reject(new Error('Supabase timeout'));
                                return;
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
                            setTimeout(check, 100);
                        };

                        check();
                    });
                },

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
                async initSupabase() {
                    try {
                        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
                        if (this.user) {
                            const { data, error } = await window.supabase
                                .from('users')
                                .upsert({
                                    telegram_id: this.user.id,
                                    username: this.user.username,
                                    first_name: this.user.first_name,
                                    last_name: this.user.last_name
                                }, {
                                    onConflict: 'telegram_id'
                                });

                            if (error) throw error;
                            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Supabase:', data);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
                    }
                },

                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                async loadData() {
                    console.log('üîÑ loadData() –≤—ã–∑–≤–∞–Ω–∞');
                    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase:', {
                        exists: !!window.supabase,
                        hasFrom: typeof window.supabase?.from,
                        from: window.supabase?.from
                    });

                    try {
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞
                        if (!window.supabase || typeof window.supabase.from !== 'function') {
                            console.error('‚ùå Supabase –Ω–µ –≥–æ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
                            return this.loadTestData();
                        }

                        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
                        console.log('üìã –ó–∞–≥—Ä—É–∂–∞—é —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫...');
                        const { data: species, error: speciesError } = await window.supabase
                            .from('plant_species')
                            .select('*')
                            .order('name');

                        if (speciesError) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:', speciesError);
                            throw speciesError;
                        }

                        this.plantSpecies = species || [];
                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∏–¥–æ–≤: ${this.plantSpecies.length}`);

                        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await this.loadUserPlants();

                        console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ loadData:', error);
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        this.loadTestData();
                    }
                },

                // –î–û–ë–ê–í–¨–¢–ï –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•:
                loadTestData() {
                    console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');

                    this.plantSpecies = [
                        { id: 1, name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞', watering_days: 7, description: '–¢–µ—Å—Ç' },
                        { id: 2, name: '–ö–∞–∫—Ç—É—Å', watering_days: 14, description: '–¢–µ—Å—Ç' },
                        { id: 3, name: '–û—Ä—Ö–∏–¥–µ—è', watering_days: 5, description: '–¢–µ—Å—Ç' }
                    ];

                    this.plants = [
                        {
                            id: 1,
                            custom_name: '–ú–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∏–∫—É—Å',
                            species_name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞',
                            watering_days: 7,
                            days_until: 2,
                            last_watered: '2024-03-12',
                            watering_progress: 71,
                            days_passed: 5
                        },
                        {
                            id: 2,
                            custom_name: '–ö–∞–∫—Ç—É—Å –Ω–∞ –æ–∫–Ω–µ',
                            species_name: '–ö–∞–∫—Ç—É—Å',
                            watering_days: 14,
                            days_until: 0,
                            last_watered: '2024-03-01',
                            watering_progress: 100,
                            days_passed: 14
                        }
                    ];

                    console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                },

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                async loadUserPlants() {
                    console.log('üåø loadUserPlants() –∑–∞–ø—É—â–µ–Ω–∞');

                    if (!this.user || !this.user.id) {
                        console.error('‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π');
                        this.plants = [];
                        return;
                    }

                    try {
                        console.log(`üîç –ò—â—É —Ä–∞—Å—Ç–µ–Ω–∏—è –¥–ª—è user_id: ${this.user.id}`);

                        const { data, error } = await window.supabase
                            .from('plants')
                            .select(`
                                            *,
                                            plant_species(name, description)
                                        `)
                            .eq('user_id', this.user.id)
                            .order('next_watering');

                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π:', {
                            data,
                            error,
                            count: data?.length
                        });

                        if (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π:', error);
                            throw error;
                        }

                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        this.plants = (data || []).map(plant => {
                            const today = new Date();
                            const nextWatering = new Date(plant.next_watering);
                            const lastWatered = new Date(plant.last_watered);

                            // –†–∞–∑–Ω–∏—Ü–∞ –≤ –¥–Ω—è–º–∏
                            const diffTime = nextWatering - today;
                            const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            // –ü—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª–∏–≤–∞
                            const daysPassed = Math.floor((today - lastWatered) / (1000 * 60 * 60 * 24));
                            const wateringProgress = Math.min(100, (daysPassed / plant.watering_days) * 100);

                            return {
                                ...plant,
                                species_name: plant.plant_species?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∏–¥',
                                days_until: daysUntil,
                                days_passed: daysPassed,
                                watering_progress: wateringProgress
                            };
                        });

                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ç–µ–Ω–∏–π: ${this.plants.length}`);

                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ loadUserPlants():', error);
                        this.plants = [];
                    }
                },

                // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                get filteredPlants() {
                    if (this.filter === 'all') return this.plants;
                    if (this.filter === 'today') return this.plants.filter(p => p.days_until <= 0);
                    if (this.filter === 'tomorrow') return this.plants.filter(p => p.days_until === 1);
                    return this.plants;
                },

                // –í—ã–±–æ—Ä –≤–∏–¥–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è
                onSpeciesChange(speciesId) {
                    if (!speciesId) {
                        this.selectedSpecies = null;
                        return;
                    }

                    const species = this.plantSpecies.find(s => s.id == speciesId);
                    if (species) {
                        this.selectedSpecies = species;
                        this.newPlant.watering_days = species.watering_days || 7;
                    } else {
                        this.selectedSpecies = null;
                    }
                },

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è
                addingPlant: false,
                async addNewPlant() {
                    if (!this.user || this.addingPlant) return;

                    this.addingPlant = true;

                    try {
                        const plantData = {
                            user_id: this.user.id,
                            custom_name: this.newPlant.custom_name.trim(),
                            species_id: this.newPlant.species_id,
                            watering_days: parseInt(this.newPlant.watering_days),
                            notes: this.newPlant.notes.trim(),
                            last_watered: new Date().toISOString().split('T')[0]
                        };

                        const { data, error } = await window.supabase
                            .from('plants')
                            .insert([plantData])
                            .select();

                        if (error) throw error;

                        // –£—Å–ø–µ—à–Ω–æ
                        this.showAddForm = false;
                        await this.loadUserPlants();

                        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                        this.newPlant = {
                            custom_name: '',
                            species_id: '',
                            watering_days: 7,
                            notes: ''
                        };
                        this.selectedSpecies = null;

                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        this.notificationStatus = '–†–∞—Å—Ç–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!';
                        setTimeout(() => this.notificationStatus = '', 3000);

                        // –ü–æ–∫–∞–∑–∞—Ç—å –≤ Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å)
                        if (window.Telegram && Telegram.WebApp) {
                            Telegram.WebApp.showAlert('–†–∞—Å—Ç–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ! –ú—ã –±—É–¥–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –ø–æ–ª–∏–≤–µ.');
                        }

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è:', error);
                        this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è';
                    } finally {
                        this.addingPlant = false;
                    }
                },

                // –ü–æ–ª–∏–≤ —Ä–∞—Å—Ç–µ–Ω–∏—è
                async waterPlant(plantId) {
                    try {
                        const today = new Date().toISOString().split('T')[0];

                        const { error } = await window.supabase
                            .from('plants')
                            .update({ last_watered: today })
                            .eq('id', plantId);

                        if (error) throw error;

                        // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª–∏–≤–æ–≤ (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å)
                        try {
                            await window.supabase
                                .from('watering_history')
                                .insert([{ plant_id: plantId }]);
                        } catch (historyError) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                        await this.loadUserPlants();

                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        const plant = this.plants.find(p => p.id === plantId);
                        if (plant) {
                            this.notificationStatus = `–†–∞—Å—Ç–µ–Ω–∏–µ "${plant.custom_name}" –ø–æ–ª–∏—Ç–æ!`;
                            setTimeout(() => this.notificationStatus = '', 3000);
                        }

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ–ª–∏–≤–∞:', error);
                        this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ–ª–∏–≤–∞';
                    }
                },

                // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è
                async showPlantDetails(plantId) {
                    try {
                        console.log('üîÑ showPlantDetails –≤—ã–∑–≤–∞–Ω —Å ID:', plantId);

                        // –ò—â–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–µ plant)
                        const targetPlant = this.plants.find(p => p.id === plantId);

                        if (!targetPlant) {
                            console.error('‚ùå –†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å ID:', plantId);
                            return;
                        }

                        console.log('üåø –ù–∞–π–¥–µ–Ω–æ —Ä–∞—Å—Ç–µ–Ω–∏–µ:', targetPlant);
                        console.log('üìã –í—Å–µ –ø–æ–ª—è —Ä–∞—Å—Ç–µ–Ω–∏—è:', Object.keys(targetPlant));

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ selectedPlant
                        this.selectedPlant = { ...targetPlant };

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º species_id
                        if (!this.selectedPlant.species_id && this.selectedPlant.plant_species) {
                            this.selectedPlant.species_id = this.selectedPlant.plant_species.id;
                            console.log('‚úÖ species_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ plant_species:', this.selectedPlant.species_id);
                        }

                        console.log('‚úÖ selectedPlant —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', this.selectedPlant);

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª–∏–≤–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                        try {
                            const { data, error } = await window.supabase
                                .from('watering_history')
                                .select('*')
                                .eq('plant_id', plantId)
                                .order('watered_date', { ascending: false })
                                .limit(8);

                            if (!error && data) {
                                this.wateringHistory = data;
                                console.log('üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–∏–≤–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', data.length, '–∑–∞–ø–∏—Å–µ–π');
                            }
                        } catch (historyError) {
                            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª–∏–≤–æ–≤:', historyError);
                        }

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        this.showDetailsModal = true;
                        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ');

                    } catch (error) {
                        console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ showPlantDetails:', error);
                    }
                },

                // –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                async deletePlant(plantId) {
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                        return;
                    }

                    try {
                        const { error } = await window.supabase
                            .from('plants')
                            .delete()
                            .eq('id', plantId);

                        if (error) throw error;

                        this.showDetailsModal = false;
                        await this.loadUserPlants();

                        this.notificationStatus = '–†–∞—Å—Ç–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
                        setTimeout(() => this.notificationStatus = '', 3000);

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è:', error);
                        this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è';
                    }
                },

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
                async loadMarketplaceProducts() {
                    this.loadingMarketplace = true;
                    try {
                        const { data, error } = await window.supabase
                            .from('marketplace_products')
                            .select('*')
                            .eq('is_active', true)
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        this.marketplaceProducts = data || [];
                        console.log(`üõí –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${this.marketplaceProducts.length}`);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                    } finally {
                        this.loadingMarketplace = false;
                    }
                },

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
                get filteredMarketplaceProducts() {
                    if (!this.marketplaceProducts) return [];

                    let filtered = this.marketplaceProducts;

                    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    if (this.marketplaceFilter !== 'all') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
                        if (this.marketplaceFilter.startsWith('related-')) {
                            // –§–∏–ª—å—Ç—Ä –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
                            const plantId = parseInt(this.marketplaceFilter.replace('related-', ''));
                            filtered = filtered.filter(p =>
                                p.attached_to_plants &&
                                p.attached_to_plants.includes(plantId.toString())
                            );

                            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
                            if (filtered.length === 0) {
                                this.notificationStatus = `–î–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤. –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ.`;
                                setTimeout(() => this.notificationStatus = '', 3000);
                            }
                        } else {
                            // –û–±—ã—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            filtered = filtered.filter(p => p.category === this.marketplaceFilter);
                        }
                    }

                    // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤)
                    if (this.marketplaceSearch && this.marketplaceSearch.trim() &&
                        !this.marketplaceFilter.startsWith('related-')) {
                        const searchTerm = this.marketplaceSearch.toLowerCase();
                        filtered = filtered.filter(p =>
                            p.name.toLowerCase().includes(searchTerm) ||
                            (p.description && p.description.toLowerCase().includes(searchTerm)) ||
                            (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                        );
                    }

                    return filtered;
                },

                // –ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                async startDiagnosis() {
                    try {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                        const { data: questions, error } = await window.supabase
                            .from('plant_doctor_questions')
                            .select('*')
                            .order('display_order')
                            .limit(1);

                        if (error) throw error;

                        if (questions && questions.length > 0) {
                            this.currentQuestion = questions[0];
                            await this.loadAnswersForQuestion(this.currentQuestion.id);
                            this.diagnosisProgress = 20;
                        }

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                        this.notificationStatus = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤';
                    }
                },

                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
                async loadAnswersForQuestion(questionId) {
                    try {
                        const { data: answers, error } = await window.supabase
                            .from('plant_doctor_answers')
                            .select('*')
                            .eq('question_id', questionId)
                            .order('display_order');

                        if (error) throw error;

                        this.currentQuestionAnswers = answers || [];

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤:', error);
                    }
                },

                // –í—ã–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç
                async selectAnswer(answer) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é
                    this.questionHistory.push({
                        question: this.currentQuestion,
                        answer: answer
                    });

                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è - –∑–∞–≤–µ—Ä—à–∞–µ–º
                    if (answer.recommendation_text) {
                        this.diagnosisResult = {
                            recommendation_text: answer.recommendation_text
                        };
                        this.currentQuestion = null;
                        this.diagnosisProgress = 100;
                        return;
                    }

                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å - –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
                    if (answer.next_question_id) {
                        try {
                            const { data: nextQuestion, error } = await window.supabase
                                .from('plant_doctor_questions')
                                .select('*')
                                .eq('id', answer.next_question_id)
                                .single();

                            if (error) throw error;

                            this.currentQuestion = nextQuestion;
                            this.currentQuestionNumber++;
                            await this.loadAnswersForQuestion(nextQuestion.id);

                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                            this.diagnosisProgress = Math.min(100, 20 + (this.currentQuestionNumber * 20));

                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:', error);
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–∞';
                        }
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
                        this.diagnosisResult = {
                            recommendation_text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ.'
                        };
                        this.currentQuestion = null;
                    }
                },

                // –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
                async goBack() {
                    if (this.questionHistory.length === 0) return;

                    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                    const last = this.questionHistory.pop();
                    this.currentQuestion = last.question;
                    this.currentQuestionNumber--;
                    await this.loadAnswersForQuestion(last.question.id);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    this.diagnosisProgress = Math.max(20, 20 + (this.currentQuestionNumber * 20));
                },

                // –ù–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                startNewDiagnosis() {
                    this.currentQuestion = null;
                    this.currentQuestionAnswers = [];
                    this.questionHistory = [];
                    this.diagnosisResult = null;
                    this.currentQuestionNumber = 1;
                    this.diagnosisProgress = 0;
                },

                // –í—ã—á–∏—Å–ª—è–µ–º–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≤–æ–ø—Ä–æ—Å–æ–≤ 
                get estimatedQuestionsLeft() {
                    if (!this.currentQuestion) return '?';
                    const estimated = Math.max(1, 5 - this.currentQuestionNumber);
                    return estimated + ' ' + this.declension(estimated, ['–≤–æ–ø—Ä–æ—Å', '–≤–æ–ø—Ä–æ—Å–∞', '–≤–æ–ø—Ä–æ—Å–æ–≤']);
                },

                // –°–∫–ª–æ–Ω–µ–Ω–∏–µ —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö
                declension(number, titles) {
                    const cases = [2, 0, 1, 1, 1, 2];
                    return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
                },

                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                getProductIcon(category) {
                    const icons = {
                        'soil': 'fas fa-tree',
                        'fertilizer': 'fas fa-flask',
                        'pot': 'fas fa-utensils',
                        'accessory': 'fas fa-toolbox'
                    };
                    return icons[category] || 'fas fa-shopping-cart';
                },

                getCategoryClass(category) {
                    const classes = {
                        'soil': 'bg-green-100 text-green-800',
                        'fertilizer': 'bg-yellow-100 text-yellow-800',
                        'pot': 'bg-purple-100 text-purple-800',
                        'accessory': 'bg-red-100 text-red-800'
                    };
                    return classes[category] || 'bg-gray-100 text-gray-800';
                },

                getCategoryName(category) {
                    const names = {
                        'soil': '–ì—Ä—É–Ω—Ç',
                        'fertilizer': '–£–¥–æ–±—Ä–µ–Ω–∏–µ',
                        'pot': '–ì–æ—Ä—à–æ–∫',
                        'accessory': '–ê–∫—Å–µ—Å—Å—É–∞—Ä'
                    };
                    return names[category] || '–¢–æ–≤–∞—Ä';
                },

                getPlantNameById(plantId) {
                    const plant = this.plantSpecies?.find(p => p.id == plantId);
                    return plant ? plant.name.split(' ')[0] : `–†–∞—Å—Ç–µ–Ω–∏–µ ${plantId}`;
                },

                showRelatedProducts(speciesId) {
                    this.showDetailsModal = false;
                    this.currentPage = 'marketplace';
                    this.marketplaceFilter = 'related-' + speciesId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
                    this.relatedProductsFilter = speciesId;

                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        this.notificationStatus = `–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –¥–ª—è ${this.getPlantNameById(speciesId)}`;
                        setTimeout(() => this.notificationStatus = '', 3000);
                    }, 100);
                },

                highlightRelatedProducts(speciesId) {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                    this.notificationStatus = `–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è`;
                    setTimeout(() => this.notificationStatus = '', 3000);
                },

                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
                getWateringStatusClass(plant) {
                    if (plant.days_until <= 0) return 'bg-red-100 text-red-800';
                    if (plant.days_until === 1) return 'bg-yellow-100 text-yellow-800';
                    if (plant.days_until <= 3) return 'bg-blue-100 text-blue-800';
                    return 'bg-gray-100 text-gray-800';
                },

                getWateringStatusText(plant) {
                    if (plant.days_until < 0) return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!';
                    if (plant.days_until === 0) return '–ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è';
                    if (plant.days_until === 1) return '–ó–∞–≤—Ç—Ä–∞';
                    return `–ß–µ—Ä–µ–∑ ${plant.days_until} –¥–Ω.`;
                },

                getNextWateringText(plant) {
                    if (plant.days_until <= 0) return '–ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è!';
                    if (plant.days_until === 1) return '–ó–∞–≤—Ç—Ä–∞';
                    return `–ß–µ—Ä–µ–∑ ${plant.days_until} –¥–Ω–µ–π`;
                },

                getTextColor(days) {
                    if (days <= 0) return 'text-red-600';
                    if (days <= 2) return 'text-yellow-600';
                    return 'text-green-600';
                },

                formatDate(dateString) {
                    if (!dateString) return '‚Äî';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return '‚Äî';
                        return date.toLocaleDateString('ru-RU', {
                            day: 'numeric',
                            month: 'long'
                        });
                    } catch (e) {
                        return '‚Äî';
                    }
                }
            };
        }
    </script>
    </div>
</body>

</html>
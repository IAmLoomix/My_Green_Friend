<!DOCTYPE html>
<html lang="ru" x-data="plantApp()" x-init="init()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø –ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥</title>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase -->
    <script src="./supabase-client.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS (–¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å—Ç–∏–ª–µ–π) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        :root {
            --primary-color: #10b981;
            --secondary-color: #059669;
        }

        .plant-card {
            transition: transform 0.2s;
        }

        .plant-card:hover {
            transform: translateY(-2px);
        }

        .urgent {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        [x-cloak] {
            display: none !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ */
        .plant-info-card {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é */
        .burger-menu {
            transition: all 0.3s ease;
        }

        .burger-line {
            transition: all 0.3s ease;
        }

        .burger-menu.open .burger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .burger-menu.open .burger-line:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.open .burger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .sidebar-menu {
            transition: transform 0.3s ease;
            transform: translateX(-100%);
        }

        .sidebar-menu.open {
            transform: translateX(0);
        }

        .page-transition {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 640px) {
            .encyclopedia-modal {
                margin: 0;
                max-height: 95vh;
                border-radius: 0;
            }

            .encyclopedia-content {
                max-height: 60vh;
                overflow-y: auto;
            }

            .plant-grid {
                grid-template-columns: 1fr !important;
            }

            .info-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .sidebar-menu {
                width: 85%;
            }
        }

        /* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
        @media (min-width: 641px) and (max-width: 768px) {
            .plant-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .info-grid {
                grid-template-columns: 1fr !important;
            }

            .sidebar-menu {
                width: 350px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ */
        .encyclopedia-plant-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .encyclopedia-plant-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
            transform: translateY(-2px);
        }

        .wiki-link {
            transition: all 0.3s ease;
            border: 1px solid #3b82f6;
        }

        .wiki-link:hover {
            background-color: #eff6ff;
            border-color: #1d4ed8;
        }

        /* –ê–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
        .active-page {
            background-color: #f0fdf4;
            border-left: 4px solid #10b981;
            color: #059669;
            font-weight: 600;
        }

        /* –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .coming-soon {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #cbd5e1;
        }

        .sidebar-menu {
            transition: transform 0.3s ease;
            transform: translateX(-100%);
            z-index: 50;
        }

        .sidebar-menu.open {
            transform: translateX(0);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–º–µ—Ä–∏—Ç–µ–ª—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ */
        .light-meter-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid #334155;
            border-radius: 18px;
            color: #e5e7eb;
        }

        .light-meter-loader {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 4px solid #334155;
            border-top-color: #22c55e;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .light-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .light-result-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 14px;
            color: #e5e7eb;
        }

        /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: */
        @media (max-width: 640px) {
            .sidebar-menu {
                width: 85%;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container mx-auto px-4 py-6 max-w-2xl">

        <!-- –®–∞–ø–∫–∞ —Å –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
        <header class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <!-- –ë—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
                <button @click="toggleMenu($event)" class="burger-menu p-2 rounded-lg hover:bg-gray-100 transition"
                    :class="{'open': isMenuOpen}">
                    <div class="w-6 h-6 flex flex-col justify-between">
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                        <div class="burger-line h-0.5 w-full bg-gray-700 rounded"></div>
                    </div>
                </button>

                <h1 class="text-3xl font-bold text-green-700">
                    <i class="fas fa-leaf mr-2"></i>
                    <span x-text="getPageTitle(currentPage)"></span>
                </h1>

                <div class="text-sm text-gray-600">
                    <span x-text="user ? user.first_name : '–ì–æ—Å—Ç—å'"></span>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π) -->
            <button x-show="currentPage === 'plants'" @click="showAddForm = true"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition">
                <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
            </button>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏) -->
            <div x-show="currentPage === 'encyclopedia'" class="mb-6">
                <div class="relative">
                    <input type="text" x-model="encyclopediaSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Å—Ç–µ–Ω–∏—è..."
                        class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </header>

        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
        <div class="sidebar-menu fixed inset-y-0 left-0 z-50 bg-white shadow-xl overflow-y-auto"
            :class="{'open': isMenuOpen}" @click.away="isMenuOpen = false">
            <div class="p-6">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-green-700">
                        <i class="fas fa-leaf mr-2"></i>–ú–µ–Ω—é
                    </h2>
                    <button @click="isMenuOpen = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="space-y-2">
                    <!-- –ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                    <button @click="changePage('plants')" :class="{'active-page': currentPage === 'plants'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-seedling mr-3 text-green-600"></i>
                        <div>
                            <div class="font-medium">–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</div>
                            <div class="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</div>
                        </div>
                    </button>

                    <!-- –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è -->
                    <button @click="changePage('encyclopedia')" :class="{'active-page': currentPage === 'encyclopedia'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-book mr-3 text-purple-600"></i>
                        <div>
                            <div class="font-medium">–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è</div>
                            <div class="text-sm text-gray-500">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö</div>
                        </div>
                    </button>

                    <!-- –ë—É–¥—É—â–∏–π —Ä–∞–∑–¥–µ–ª 1 -->
                    <button @click="changePage('future1')" :class="{'active-page': currentPage === 'future1'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-calendar-alt mr-3 text-blue-600"></i>
                        <div>
                            <div class="font-medium">–ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</div>
                            <div class="text-sm text-gray-500">–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                        </div>
                    </button>

                    <!-- –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ -->
                    <button @click="changePage('light')" :class="{'active-page': currentPage === 'light'}"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition flex items-center">
                        <i class="fas fa-sun mr-3 text-yellow-600"></i>
                        <div>
                            <div class="font-medium">–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏</div>
                            <div class="text-sm text-gray-500">–ò–∑–º–µ—Ä—å—Ç–µ —Å–≤–µ—Ç –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                        </div>
                    </button>
                </div>

                <div class="mt-12 pt-6 border-t border-gray-200">
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="text-4xl">üåø</div>
                            <div class="text-lg font-bold text-green-700 mt-2">–ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥</div>
                        </div>
                        <p class="text-sm text-gray-500">–®–∫–æ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç "–ü–æ–ª—ë—Ç"</p>
                        <p class="text-xs text-gray-400 mt-2">–í–µ—Ä—Å–∏—è 0.3.0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é -->
        <div x-show="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü -->
        <div class="page-transition">
            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è" -->
            <div x-show="currentPage === 'plants'">
                <!-- –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div x-show="notificationStatus" class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                    <div class="flex items-center">
                        <i class="fas fa-bell text-blue-500 mr-3 text-lg"></i>
                        <div>
                            <p class="font-medium text-blue-800" x-text="notificationStatus"></p>
                            <p class="text-sm text-blue-600 mt-1">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 10:00</p>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                <div x-show="!loading && plants.length > 0" class="mb-10">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">–í—Å–µ —Ä–∞—Å—Ç–µ–Ω–∏—è (<span
                            x-text="plants.length"></span>)</h2>

                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="flex space-x-2 mb-4">
                        <button @click="filter = 'all'"
                            :class="filter === 'all' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –í—Å–µ
                        </button>
                        <button @click="filter = 'today'"
                            :class="filter === 'today' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è
                        </button>
                        <button @click="filter = 'tomorrow'"
                            :class="filter === 'tomorrow' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'"
                            class="px-3 py-1 rounded-full text-sm font-medium transition">
                            –ó–∞–≤—Ç—Ä–∞
                        </button>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                    <div class="space-y-4">
                        <template x-for="plant in filteredPlants" :key="plant.id">
                            <div class="plant-card bg-white rounded-xl shadow-sm p-4 border border-gray-200"
                                :class="{'border-red-300 urgent': plant.days_until <= 0}">

                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800" x-text="plant.custom_name"></h3>
                                        <p class="text-gray-600 text-sm" x-text="plant.species_name"></p>
                                    </div>

                                    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–ª–∏–≤–∞ -->
                                    <div class="text-right">
                                        <span class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                                            :class="getWateringStatusClass(plant)">
                                            <span x-text="getWateringStatusText(plant)"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ -->
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <p class="text-gray-500">–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞</p>
                                        <p class="font-medium" x-text="plant.watering_days + ' –¥–Ω–µ–π'"></p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</p>
                                        <p class="font-medium" x-text="formatDate(plant.last_watered)"></p>
                                    </div>
                                </div>

                                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–ª–∏–≤–∞ -->
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª–∏–≤–∞</span>
                                        <span x-text="plant.days_passed + '/' + plant.watering_days + ' –¥–Ω–µ–π'"></span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500 rounded-full transition-all duration-500"
                                            :style="'width: ' + plant.watering_progress + '%'"></div>
                                    </div>
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                <div class="flex space-x-2">
                                    <button @click="waterPlant(plant.id)"
                                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center transition">
                                        <i class="fas fa-tint mr-2"></i>–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                                    </button>
                                    <button @click="showPlantDetails(plant.id)"
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                        <i class="fas fa-info"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π -->
                <div x-show="!loading && plants.length === 0" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-seedling text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π</h3>
                    <p class="text-gray-500 mb-6">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ, –∏ –º—ã –Ω–∞–ø–æ–º–Ω–∏–º –∫–æ–≥–¥–∞ –µ–≥–æ –ø–æ–ª–∏–≤–∞—Ç—å</p>
                    <button @click="showAddForm = true"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg">
                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
                    </button>
                    <button @click="addDemoPlants()"
                        class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è
                    </button>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è" -->
            <div x-show="currentPage === 'encyclopedia'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π (<span x-text="filteredEncyclopedia.length"></span> –≤–∏–¥–æ–≤)
                    </h2>
                    <p class="text-gray-600 mb-4">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∏–¥–∞—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π, —É—Å–ª–æ–≤–∏—è—Ö –∏—Ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏ —É—Ö–æ–¥–µ
                    </p>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
                <div class="plant-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <template x-for="plant in filteredEncyclopedia" :key="plant.id">
                        <button @click="showEncyclopediaDetail(plant)"
                            class="encyclopedia-plant-card p-3 bg-gray-50 hover:bg-green-50 rounded-lg text-left transition">
                            <div class="font-medium text-gray-800 text-sm truncate" x-text="plant.name"></div>
                            <div class="text-xs text-gray-500 mt-1 truncate">
                                –ü–æ–ª–∏–≤ –∫–∞–∂–¥—ã–µ <span x-text="plant.watering_days"></span> –¥–Ω–µ–π
                            </div>
                            <div class="text-xs text-gray-400 mt-2 line-clamp-2" x-text="plant.description || ''"></div>
                        </button>
                    </template>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ -->
                <div x-show="encyclopediaSearch && filteredEncyclopedia.length === 0" class="text-center py-12">
                    <div class="mb-6">
                        <i class="fas fa-search text-5xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">–†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞</p>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ë—É–¥—É—â–∏–π —Ä–∞–∑–¥–µ–ª 1" -->
            <div x-show="currentPage === 'future1'">
                <div class="text-center py-12">
                    <div class="coming-soon p-8 rounded-2xl mb-8">
                        <i class="fas fa-calendar-alt text-6xl text-blue-300 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-2">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Ö–æ–¥–∞</h2>
                        <p class="text-gray-600 mb-6">–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!</p>
                        <div class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-full">
                            <i class="fas fa-tools mr-2"></i>
                            <span>–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
                        </div>
                    </div>
                    <p class="text-gray-500">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏" -->
            <div x-show="currentPage === 'light'">
                <div class="light-meter-card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-2">
                        <i class="fas fa-sun mr-2 text-yellow-400"></i>–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    </h2>
                    <p class="text-gray-300 mb-6">
                        –ü–æ–ª–æ–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä—è–¥–æ–º —Å —Ä–∞—Å—Ç–µ–Ω–∏–µ–º
                    </p>

                    <button @click="measureLight()" :disabled="lightLoading"
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-60 disabled:cursor-not-allowed">
                        <i class="fas fa-camera mr-2"></i>–ò–∑–º–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
                    </button>

                    <template x-if="lightLoading">
                        <div class="mt-8 text-center">
                            <div class="light-meter-loader"></div>
                            <p class="text-gray-300 mt-4">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–µ‚Ä¶</p>
                            <p class="text-sm text-gray-400">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ</p>
                        </div>
                    </template>

                    <template x-if="lightResult">
                        <div class="mt-8 light-result-card p-5">
                            <div class="flex items-center justify-between mb-4">
                                <span class="light-badge" :style="`background: ${lightResult.color}`"
                                    x-text="lightResult.label"></span>
                                <button @click="lightResult = null" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="space-y-3">
                                <div>
                                    <h3 class="font-medium text-white mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</h3>
                                    <p class="text-gray-300" x-text="lightResult.description"></p>
                                </div>

                                <div>
                                    <h3 class="font-medium text-white mb-1">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è:</h3>
                                    <p class="text-gray-300" x-text="lightResult.plants"></p>
                                </div>

                                <div class="pt-4 border-t border-gray-700">
                                    <h3 class="font-medium text-white mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3>
                                    <ul class="text-sm text-gray-300 space-y-1">
                                        <template x-if="lightResult.label === '–û—á–µ–Ω—å —Ç–µ–º–Ω–æ'">
                                            <li>‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</li>
                                        </template>
                                        <template x-if="lightResult.label === '–¢—É—Å–∫–ª–æ'">
                                            <li>‚Ä¢ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–°—Ä–µ–¥–Ω–µ'">
                                            <li>‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–Ø—Ä–∫–æ'">
                                            <li>‚Ä¢ –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                        </template>
                                        <template x-if="lightResult.label === '–û—á–µ–Ω—å —è—Ä–∫–æ'">
                                            <li>‚Ä¢ –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ –ø–æ–ª–¥–µ–Ω—å</li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div class="mt-6 text-center text-sm text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤–µ—Ç–∞, –∞ –Ω–µ —è—Ä–∫–æ—Å—Ç—å –∫–∞–º–µ—Ä—ã
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–∞—Ö –æ—Å–≤–µ—â–µ–Ω–∏—è -->
                <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>–¢–∏–ø—ã –æ—Å–≤–µ—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Ç–µ–Ω–∏–π
                    </h3>

                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="w-3 h-3 rounded-full bg-gray-500 mt-1 mr-3"></div>
                            <div>
                                <h4 class="font-medium text-gray-700">–û—á–µ–Ω—å —Ç–µ–º–Ω–æ</h4>
                                <p class="text-sm text-gray-600">–¢–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º—ã—Ö —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (—Å–∞–Ω—Å–µ–≤–∏–µ—Ä–∏—è,
                                    –∑–∞–º–∏–æ–∫—É–ª—å–∫–∞—Å)</p>
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="w-3 h-3 rounded-full bg-gray-400 mt-1 mr-3"></div>
                            <div>
                                <h4 class="font-medium text-gray-700">–¢—É—Å–∫–ª–æ</h4>
                                <p class="text-sm text-gray-600">–î–ª—è —Ç–µ–Ω–µ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (–ø–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫–∏, —Ñ–∏–ª–æ–¥–µ–Ω–¥—Ä–æ–Ω—ã)
                                </p>
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="w-3 h-3 rounded-full bg-yellow-400 mt-1 mr-3"></div>
                            <div>
                                <h4 class="font-medium text-gray-700">–°—Ä–µ–¥–Ω–µ</h4>
                                <p class="text-sm text-gray-600">–ü–æ–¥—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</p>
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="w-3 h-3 rounded-full bg-orange-400 mt-1 mr-3"></div>
                            <div>
                                <h4 class="font-medium text-gray-700">–Ø—Ä–∫–æ</h4>
                                <p class="text-sm text-gray-600">–î–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π (—Å—É–∫–∫—É–ª–µ–Ω—Ç—ã, —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ)</p>
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="w-3 h-3 rounded-full bg-red-400 mt-1 mr-3"></div>
                            <div>
                                <h4 class="font-medium text-gray-700">–û—á–µ–Ω—å —è—Ä–∫–æ</h4>
                                <p class="text-sm text-gray-600">–ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ —Å–∞–º—ã–µ —Å–æ–ª–Ω–µ—á–Ω—ã–µ —á–∞—Å—ã
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü) -->
            <div x-show="loading === true" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-600">
                </div>
                <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è -->
            <div x-show="showAddForm"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">–ù–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</h2>
                            <button @click="showAddForm = false" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <form @submit.prevent="addNewPlant">
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                            <div class="mb-5">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <i class="fas fa-tag mr-2"></i>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                                </label>
                                <input type="text" x-model="newPlant.custom_name"
                                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –ª—é–±–∏–º—ã–π —Ñ–∏–∫—É—Å" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                            </div>

                            <!-- –í—ã–±–æ—Ä –≤–∏–¥–∞ -->
                            <div class="mb-5">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <i class="fas fa-seedling mr-2"></i>–í–∏–¥ —Ä–∞—Å—Ç–µ–Ω–∏—è
                                </label>
                                <div class="relative">
                                    <select x-model="newPlant.species_id" required
                                        @change="onSpeciesChange($event.target.value)"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg appearance-none focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition bg-white">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞—Å—Ç–µ–Ω–∏—è</option>
                                        <template x-for="species in plantSpecies" :key="species.id">
                                            <option :value="species.id"
                                                x-text="species.name + ' (–ø–æ–ª–∏–≤ –∫–∞–∂–¥—ã–µ ' + species.watering_days + ' –¥–Ω–µ–π)'">
                                            </option>
                                        </template>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ -->
                                <div x-show="selectedSpecies && selectedSpecies.description"
                                    class="mt-3 p-3 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-800" x-text="selectedSpecies?.description || ''"></p>
                                    <p class="text-sm font-medium text-green-900 mt-1">
                                        –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–ª–∏–≤: –∫–∞–∂–¥—ã–µ
                                        <span x-text="selectedSpecies?.watering_days || '?'"></span> –¥–Ω–µ–π
                                    </p>
                                </div>
                            </div>

                            <!-- –ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å) -->
                            <div class="mb-5">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i>–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–∏–≤–∞ (–¥–Ω–µ–π)
                                </label>
                                <input type="number" x-model="newPlant.watering_days" min="1" max="30" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition">
                                <p class="text-sm text-gray-500 mt-2">–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏</p>
                            </div>

                            <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
                            <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <i class="fas fa-sticky-note mr-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                                </label>
                                <textarea x-model="newPlant.notes" rows="2"
                                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç–æ–∏—Ç –Ω–∞ –∫—É—Ö–æ–Ω–Ω–æ–º –æ–∫–Ω–µ"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition resize-none"></textarea>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ -->
                            <div class="flex space-x-3">
                                <button type="button" @click="showAddForm = false"
                                    class="flex-1 py-3 px-4 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" :disabled="addingPlant"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!addingPlant">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ</span>
                                    <span x-show="addingPlant">–î–æ–±–∞–≤–ª—è–µ–º...</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Å—Ç–µ–Ω–∏—è -->
            <div x-show="showDetailsModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800" x-text="selectedPlant.custom_name"></h2>
                                <p class="text-gray-600" x-text="selectedPlant.species_name"></p>
                            </div>
                            <button @click="showDetailsModal = false" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="space-y-4 mb-6">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">–°–ª–µ–¥—É—é—â–∏–π –ø–æ–ª–∏–≤</span>
                                    <span class="font-medium" :class="getTextColor(selectedPlant.days_until)"
                                        x-text="getNextWateringText(selectedPlant)"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤</span>
                                    <span class="font-medium" x-text="formatDate(selectedPlant.last_watered)"></span>
                                </div>
                            </div>

                            <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
                            <div x-show="selectedPlant.notes" class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-medium text-blue-800 mb-1"><i
                                        class="fas fa-sticky-note mr-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
                                </h4>
                                <p class="text-blue-900" x-text="selectedPlant.notes"></p>
                            </div>
                        </div>

                        <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–∏–≤–æ–≤ -->
                        <template x-if="wateringHistory && wateringHistory.length > 0">
                            <div class="mb-3">
                                <h4 class="font-medium text-gray-700 mb-3"><i class="fas fa-history mr-2"></i>–ò—Å—Ç–æ—Ä–∏—è
                                    –ø–æ–ª–∏–≤–æ–≤</h4>
                                <div class="space-y-2">
                                    <template x-for="record in wateringHistory" :key="record.id">
                                        <div class="flex items-center text-sm">
                                            <i class="fas fa-tint text-blue-500 mr-3"></i>
                                            <span class="text-gray-600" x-text="formatDate(record.watered_date)"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex space-x-2">
                                <button @click="waterPlant(selectedPlant.id); showDetailsModal = false;"
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition">
                                    <i class="fas fa-tint mr-2"></i>–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                                </button>
                                <button @click="deletePlant(selectedPlant.id)"
                                    class="px-4 py-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <!-- –ö–Ω–æ–ø–∫–∞ –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è -->
                            <button @click="showEncyclopediaDetailFromPlant(selectedPlant.species_name)"
                                class="w-full mt-2 bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition">
                                <i class="fas fa-book mr-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
            <div x-show="showEncyclopediaModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div
                    class="bg-white encyclopedia-modal w-full max-w-2xl max-h-[90vh] overflow-hidden rounded-2xl shadow-xl">
                    <div class="p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-4 sm:mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                                <i class="fas fa-book text-purple-500 mr-2"></i>–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π
                            </h2>
                            <button @click="showEncyclopediaModal = false"
                                class="text-gray-400 hover:text-gray-600 p-1">
                                <i class="fas fa-times text-xl sm:text-2xl"></i>
                            </button>
                        </div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è -->
                        <div x-show="encyclopediaPlantName"
                            class="mb-4 sm:mb-6 p-3 sm:p-4 bg-gradient-to-r from-purple-50 to-green-50 rounded-xl border border-purple-100">
                            <h3 class="text-lg sm:text-xl font-bold text-gray-800 truncate"
                                x-text="encyclopediaPlantName || '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ'"></h3>
                            <p class="text-gray-600 text-sm mt-1">–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ö–æ–¥–µ</p>
                        </div>

                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ -->
                        <div class="encyclopedia-content">
                            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–∏ -->
                            <div x-show="currentPlantInfo" class="mb-6">
                                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
                                <div class="plant-info-card p-4 sm:p-5 rounded-lg mb-4">
                                    <div class="info-grid grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                                        <div class="space-y-2">
                                            <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                                <i class="fas fa-seedling mr-2 text-sm"></i>–û–ø–∏—Å–∞–Ω–∏–µ
                                            </h4>
                                            <p class="text-gray-700 text-sm sm:text-base"
                                                x-text="currentPlantInfo?.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
                                        </div>
                                        <div class="space-y-2">
                                            <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                                <i
                                                    class="fas fa-temperature-high mr-2 text-sm"></i>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–æ—Å–≤–µ—â–µ–Ω–∏–µ
                                            </h4>
                                            <p class="text-gray-700 text-sm sm:text-base"
                                                x-text="currentPlantInfo?.temperature || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
                                        </div>
                                        <div class="space-y-2">
                                            <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                                <i class="fas fa-tint mr-2 text-sm"></i>–ü–æ–ª–∏–≤
                                            </h4>
                                            <p class="text-gray-700 text-sm sm:text-base"
                                                x-text="currentPlantInfo?.watering_details || currentPlantInfo?.watering || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'">
                                            </p>
                                        </div>
                                        <div class="space-y-2">
                                            <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                                <i class="fas fa-spa mr-2 text-sm"></i>–ü–æ–¥–∫–æ—Ä–º–∫–∞
                                            </h4>
                                            <p class="text-gray-700 text-sm sm:text-base"
                                                x-text="currentPlantInfo?.feeding || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
                                        </div>
                                        <div class="md:col-span-2 space-y-2">
                                            <h4 class="font-bold text-green-800 text-sm sm:text-base flex items-center">
                                                <i class="fas fa-tree mr-2 text-sm"></i>–ü–æ—á–≤–∞
                                            </h4>
                                            <p class="text-gray-700 text-sm sm:text-base"
                                                x-text="currentPlantInfo?.soil || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –†—É–≤–∏–∫–∏ -->
                                <div x-show="currentPlantInfo?.wiki_url" class="mb-6">
                                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                        <h4 class="font-bold text-blue-800 text-sm sm:text-base mb-2 flex items-center">
                                            <i class="fas fa-external-link-alt mr-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –†—É–≤–∏–∫–∏
                                        </h4>
                                        <p class="text-blue-700 text-sm mb-3">–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç—å—è –æ —Ä–∞—Å—Ç–µ–Ω–∏–∏ –≤ —Ä—É—Å—Å–∫–æ–π
                                            —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏</p>
                                        <a :href="currentPlantInfo?.wiki_url" target="_blank"
                                            class="wiki-link inline-flex items-center px-4 py-2 bg-white text-blue-600 rounded-lg font-medium hover:no-underline">
                                            <i class="fab fa-wikipedia-w mr-2"></i>
                                            <span>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é –≤ –†—É–≤–∏–∫–∏</span>
                                            <i class="fas fa-external-link-alt ml-2 text-sm"></i>
                                        </a>
                                        <p class="text-xs text-blue-500 mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            –û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –§—É—Ç–µ—Ä -->
            <footer class="mt-12 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
                <p>üåø –ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥ ‚Ä¢ –®–∫–æ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç "–ü–æ–ª—ë—Ç" ‚Ä¢ –í–µ—Ä—Å–∏—è 0.3.0</p>
                <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 10:00</p>
                <p class="mt-2">–†–∞—Å—Ç–µ–Ω–∏–π –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏: <span x-text="plantEncyclopedia.length"></span> –≤–∏–¥–æ–≤</p>
            </footer>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <script>
            function plantApp() {
                return {
                    // –î–æ–±–∞–≤–ª—è–µ–º $nextTick –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    $nextTick: (fn) => setTimeout(fn, 0),

                    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    loading: true,
                    user: null,
                    plants: [],
                    plantSpecies: [],
                    wateringHistory: [],

                    // –§–∏–ª—å—Ç—Ä—ã
                    filter: 'all',

                    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                    showAddForm: false,
                    showDetailsModal: false,
                    showEncyclopediaModal: false,

                    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                    currentPage: 'plants',
                    isMenuOpen: false,

                    // –ü–æ–∏—Å–∫ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                    encyclopediaSearch: '',

                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    newPlant: {
                        custom_name: '',
                        species_id: '',
                        watering_days: 7,
                        notes: ''
                    },

                    // –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                    selectedPlant: {},
                    selectedSpecies: null,

                    // –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è
                    encyclopediaPlantName: '',
                    currentPlantInfo: null,
                    plantEncyclopedia: [],

                    // –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    lightLoading: false,
                    lightResult: null,

                    // –°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    notificationStatus: '',

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                    async init() {
                        console.log('üöÄ init() –≤—ã–∑–≤–∞–Ω');

                        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
                        if (this._initializing) return;
                        this._initializing = true;

                        this.loading = true;
                        console.log('1. loading —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true');

                        try {
                            // 1. –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Supabase
                            console.log('‚è≥ –ñ–¥—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Supabase...');
                            await this.waitForSupabaseReady();

                            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
                            console.log('2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é Telegram...');
                            this.initTelegram();

                            // 3. –°–û–ó–î–ê–ï–ú/–ü–†–û–í–ï–†–Ø–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–î
                            console.log('3. –°–æ–∑–¥–∞—é/–ø—Ä–æ–≤–µ—Ä—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î...');
                            await this.ensureUserExists();

                            // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                            console.log('4. –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...');
                            await this.loadData();

                            // 5. –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î
                            console.log('5. –ó–∞–≥—Ä—É–∂–∞—é —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î...');
                            await this.loadEncyclopedia();

                            console.log('üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!');

                        } catch (error) {
                            console.error('üí• –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è';
                        } finally {
                            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                            setTimeout(() => {
                                this.loading = false;
                                console.log('‚úÖ loading —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ false');
                            }, 100);
                        }
                    },

                    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                    changePage(page) {
                        this.currentPage = page;
                        this.isMenuOpen = false;

                        // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
                        if (page === 'encyclopedia') {
                            this.encyclopediaSearch = '';
                        }

                        // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        if (page === 'light') {
                            this.lightResult = null;
                        }

                        // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —Ä–∞—Å—Ç–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if (page === 'plants') {
                            this.loadUserPlants();
                        }
                    },

                    // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    getPageTitle(page) {
                        const titles = {
                            'plants': '–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è',
                            'encyclopedia': '–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è',
                            'future1': '–ó–µ–ª—ë–Ω—ã–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å',
                            'light': '–û—Ü–µ–Ω–∫–∞ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏'
                        };
                        return titles[page] || '–ú–æ–π –∑–µ–ª—ë–Ω—ã–π –¥—Ä—É–≥';
                    },

                    // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–µ–Ω—é
                    toggleMenu(event) {
                        event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                        this.isMenuOpen = !this.isMenuOpen;
                    },

                    // –ò–∑–º–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
                    async measureLight() {
                        if (this.lightLoading) return;

                        this.lightLoading = true;
                        this.lightResult = null;

                        try {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                                throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                            }

                            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                            const stream = await navigator.mediaDevices.getUserMedia({
                                video: {
                                    facingMode: "environment",
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            });

                            const video = document.createElement("video");
                            video.srcObject = stream;
                            await video.play();

                            // –ñ–¥—ë–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏
                            await new Promise(r => setTimeout(r, 800));

                            const canvas = document.createElement("canvas");
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;

                            const ctx = canvas.getContext("2d");
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const stats = this.analyzeLight(imageData.data);
                            this.lightResult = this.classifyLight(stats);

                            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                            stream.getTracks().forEach(track => track.stop());

                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏:', error);

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (error.message.includes('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞') ||
                                error.message.includes('permission') ||
                                window.location.protocol === 'http:') {

                                // –î–µ–º–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
                                const demoStats = {
                                    brightRatio: 0.12,
                                    darkRatio: 0.3,
                                    contrast: 180
                                };
                                this.lightResult = this.classifyLight(demoStats);
                                this.notificationStatus = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º (–±–µ–∑ –∫–∞–º–µ—Ä—ã)';
                                setTimeout(() => this.notificationStatus = '', 3000);
                            } else {
                                this.notificationStatus = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
                                setTimeout(() => this.notificationStatus = '', 3000);
                            }
                        } finally {
                            this.lightLoading = false;
                        }
                    },

                    // –ê–Ω–∞–ª–∏–∑ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    analyzeLight(data) {
                        let bright = 0;
                        let dark = 0;
                        let max = 0;
                        let min = 255;
                        const total = data.length / 4;

                        for (let i = 0; i < data.length; i += 4) {
                            const lum = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];

                            if (lum > 200) bright++;
                            if (lum < 40) dark++;

                            max = Math.max(max, lum);
                            min = Math.min(min, lum);
                        }

                        return {
                            brightRatio: bright / total,
                            darkRatio: dark / total,
                            contrast: max - min
                        };
                    },

                    // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏
                    classifyLight(s) {
                        if (s.brightRatio < 0.02 && s.darkRatio > 0.6) {
                            return {
                                label: "–û—á–µ–Ω—å —Ç–µ–º–Ω–æ",
                                color: "#64748b",
                                description: "–û—Å–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –†–∞—Å—Ç–µ–Ω–∏—è –±—É–¥—É—Ç —Å—Ç—Ä–∞–¥–∞—Ç—å –æ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å–≤–µ—Ç–∞.",
                                plants: "–¢–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º—ã—Ö —Ç–µ–Ω–µ–≤—ã–Ω–æ—Å–ª–∏–≤—ã—Ö: —Å–∞–Ω—Å–µ–≤–∏–µ—Ä–∏—è, –∑–∞–º–∏–æ–∫—É–ª—å–∫–∞—Å"
                            };
                        }

                        if (s.brightRatio < 0.05) {
                            return {
                                label: "–¢—É—Å–∫–ª–æ",
                                color: "#94a3b8",
                                description: "–°–ª–∞–±–æ–µ —Ä–∞—Å—Å–µ—è–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ–Ω–µ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                                plants: "–ü–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫–∏, —Ñ–∏–ª–æ–¥–µ–Ω–¥—Ä–æ–Ω—ã, –∞–≥–ª–∞–æ–Ω–µ–º–∞"
                            };
                        }

                        if (s.brightRatio < 0.15) {
                            return {
                                label: "–°—Ä–µ–¥–Ω–µ",
                                color: "#facc15",
                                description: "–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–≤–µ—Ç–∞. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                                plants: "–§–∏–∫—É—Å—ã, –º–æ–Ω—Å—Ç–µ—Ä–∞, —Å–ø–∞—Ç–∏—Ñ–∏–ª–ª—É–º, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–ª–∏—Å—Ç–Ω—ã—Ö"
                            };
                        }

                        if (s.brightRatio < 0.35) {
                            return {
                                label: "–Ø—Ä–∫–æ",
                                color: "#fb923c",
                                description: "–•–æ—Ä–æ—à–æ –æ—Å–≤–µ—â—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–≤–µ—Ç–æ–ª—é–±–∏–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
                                plants: "–°—É–∫–∫—É–ª–µ–Ω—Ç—ã, –∫–∞–∫—Ç—É—Å—ã, —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ, –≥–∏–±–∏—Å–∫—É—Å"
                            };
                        }

                        return {
                            label: "–û—á–µ–Ω—å —è—Ä–∫–æ",
                            color: "#f97316",
                            description: "–û—á–µ–Ω—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —Å–≤–µ—Ç. –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –≤ —Å–∞–º—ã–µ —Å–æ–ª–Ω–µ—á–Ω—ã–µ —á–∞—Å—ã.",
                            plants: "–ü—É—Å—Ç—ã–Ω–Ω—ã–µ –∫–∞–∫—Ç—É—Å—ã, –∞–ª–æ—ç, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥—ã –∞–≥–∞–≤—ã"
                        };
                    },

                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É
                    get filteredEncyclopedia() {
                        if (!this.encyclopediaSearch) {
                            return this.plantEncyclopedia;
                        }

                        const searchTerm = this.encyclopediaSearch.toLowerCase();
                        return this.plantEncyclopedia.filter(plant =>
                            plant.name.toLowerCase().includes(searchTerm) ||
                            (plant.description && plant.description.toLowerCase().includes(searchTerm))
                        );
                    },

                    // –ó–∞–≥—Ä—É–∑–∫–∞ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ –ë–î
                    async loadEncyclopedia() {
                        try {
                            if (!window.supabase || typeof window.supabase.from !== 'function') {
                                console.error('‚ùå Supabase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏');
                                this.showAlert('–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                                return;
                            }

                            console.log('üìö –ó–∞–≥—Ä—É–∂–∞—é —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é –∏–∑ –ë–î...');

                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã plant_species —Å –í–°–ï–ú–ò –ø–æ–ª—è–º–∏
                            const { data, error } = await window.supabase
                                .from('plant_species')
                                .select('*')
                                .order('name');

                            if (error) {
                                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏:', error);
                                this.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏! –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                                return;
                            }

                            if (data && data.length > 0) {
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ: –µ—Å–ª–∏ –Ω–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π, –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                                this.plantEncyclopedia = data.map(plant => {
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∞–ª–∏ –ø–æ–ª–∏–≤–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ
                                    const wateringDetails = plant.watering_details ||
                                        plant.watering ||
                                        `—Ä–∞–∑ –≤ ${plant.watering_days} –¥–Ω–µ–π`;

                                    return {
                                        ...plant,
                                        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –µ—Å—Ç—å
                                        soil: plant.soil || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø–æ—á–≤–∞',
                                        temperature: plant.temperature || '+18‚Ä¶+25‚ÄØ¬∞C',
                                        watering_details: wateringDetails,
                                        feeding: plant.feeding || '1 —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –≤ –ø–µ—Ä–∏–æ–¥ —Ä–æ—Å—Ç–∞',
                                        wiki_url: plant.wiki_url || null
                                    };
                                });
                                console.log(`‚úÖ –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –ë–î: ${data.length} —Ä–∞—Å—Ç–µ–Ω–∏–π`);
                            } else {
                                console.warn('‚ö†Ô∏è –í –ë–î –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏');
                                this.showAlert('–î–∞–Ω–Ω—ã—Ö –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                            }

                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏:', error);
                            this.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏\n ‚ãÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—É.\n ‚ãÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.');
                        }
                    },

                    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                    showEncyclopediaDetail(plant) {
                        this.encyclopediaPlantName = plant.name;
                        this.currentPlantInfo = plant;
                        this.showEncyclopediaModal = true;
                    },

                    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏ –∏–∑ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    showEncyclopediaDetailFromPlant(plantName) {
                        this.showDetailsModal = false;
                        this.encyclopediaPlantName = plantName;

                        // –ù–∞–π—Ç–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏
                        const plantInfo = this.plantEncyclopedia.find(p =>
                            p.name.toLowerCase().includes(plantName.toLowerCase()) ||
                            plantName.toLowerCase().includes(p.name.toLowerCase().split(' ')[0])
                        );

                        if (plantInfo) {
                            this.currentPlantInfo = plantInfo;
                            this.showEncyclopediaModal = true;
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —á–∞—Å—Ç—è–º
                            const searchTerms = plantName.toLowerCase().split(' ');
                            for (let term of searchTerms) {
                                if (term.length > 3) {
                                    const found = this.plantEncyclopedia.find(p =>
                                        p.name.toLowerCase().includes(term)
                                    );
                                    if (found) {
                                        this.currentPlantInfo = found;
                                        this.showEncyclopediaModal = true;
                                        return;
                                    }
                                }
                            }

                            // –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –Ω–∞—à–ª–∏
                            this.currentPlantInfo = {
                                name: plantName,
                                description: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Ç–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –Ω–∞—à—É —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—é.',
                                soil: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                                temperature: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                                watering_details: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                                feeding: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                                wiki_url: null
                            };
                            this.showEncyclopediaModal = true;
                        }
                    },

                    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    showAlert(message) {
                        if (window.Telegram?.WebApp) {
                            Telegram.WebApp.showAlert(message);
                        } else {
                            this.notificationStatus = message;
                            setTimeout(() => this.notificationStatus = '', 3000);
                        }
                    },

                    // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    async ensureUserExists() {
                        console.log('–ü—Ä–æ–≤–µ—Ä—è—é/—Å–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î...');

                        if (!this.user || !this.user.id) {
                            console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                            return;
                        }

                        try {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ
                            const userData = {
                                telegram_id: this.user.id,
                                username: this.user.username || '',
                                first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                                last_name: this.user.last_name || '',
                                created_at: new Date().toISOString()
                            };

                            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è UPSERT:', userData);

                            const { data, error } = await window.supabase
                                .from('users')
                                .upsert(userData, {
                                    onConflict: 'telegram_id',
                                    ignoreDuplicates: false
                                })
                                .select();

                            if (error) {
                                console.error('‚ùå –û—à–∏–±–∫–∞ UPSERT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);

                                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –Ω–µ–≥–æ
                                if (error.message.includes('updated_at') || error.message.includes('column')) {
                                    console.log('‚ö†Ô∏è –£–¥–∞–ª—è—é updated_at –∏–∑ –∑–∞–ø—Ä–æ—Å–∞...');
                                    return await this.ensureUserExistsSimple();
                                }

                                if (error.code === '23505') { // unique_violation
                                    console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                                    return;
                                }

                                throw error;
                            }

                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î:', data);

                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ ensureUserExists:', error);
                        }
                    },

                    // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ updated_at
                    async ensureUserExistsSimple() {
                        try {
                            const userData = {
                                telegram_id: this.user.id,
                                username: this.user.username || '',
                                first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                                last_name: this.user.last_name || '',
                                created_at: new Date().toISOString()
                            };

                            console.log('–ü—Ä–æ–±—É—é –ø—Ä–æ—Å—Ç–æ–π UPSERT:', userData);

                            const { error } = await window.supabase
                                .from('users')
                                .upsert(userData, {
                                    onConflict: 'telegram_id'
                                });

                            if (error) {
                                console.error('–ü—Ä–æ—Å—Ç–æ–π UPSERT —Ç–æ–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', error);

                                // –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –¥—É–±–ª–∏–∫–∞—Ç—ã
                                const { error: insertError } = await window.supabase
                                    .from('users')
                                    .insert(userData)
                                    .select();

                                if (insertError && insertError.code !== '23505') {
                                    console.error('–ò INSERT –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', insertError);
                                }
                            }

                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω');

                        } catch (error) {
                            console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                        }
                    },

                    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
                    /*
                     async createUserManually() {
                        if (!this.user) {
                            alert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                            return;
                        }

                        try {
                            this.notificationStatus = '–°–æ–∑–¥–∞—é –ø—Ä–æ—Ñ–∏–ª—å...';

                            const userData = {
                                telegram_id: this.user.id,
                                username: this.user.username || '',
                                first_name: this.user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                                last_name: this.user.last_name || '',
                                created_at: new Date().toISOString()
                            };

                            console.log('–°–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);

                            const { error } = await window.supabase
                                .from('users')
                                .insert([userData]);

                            if (error) {
                                console.error('–û—à–∏–±–∫–∞:', error);
                                alert(`–û—à–∏–±–∫–∞: ${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase.`);
                            } else {
                                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!');
                                alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è.');
                                this.notificationStatus = '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω!';
                            }
                        } catch (error) {
                            console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', error);
                            alert('–û—à–∏–±–∫–∞: ' + error.message);
                        }
                    },
                        */
                    // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ:
                    async waitForSupabaseReady() {
                        console.log('waitForSupabaseReady –≤—ã–∑–≤–∞–Ω–∞');
                        console.log('–¢–µ–∫—É—â–∏–π window.supabase:', window.supabase);
                        console.log('window.supabase.from:', typeof window.supabase?.from);

                        return new Promise((resolve) => {
                            let attempts = 0;
                            const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥

                            const check = () => {
                                attempts++;

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ supabase —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥ .from
                                if (window.supabase && typeof window.supabase.from === 'function') {
                                    console.log(`‚úÖ Supabase –≥–æ—Ç–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ ${attempts})`);
                                    resolve();
                                    return;
                                }

                                if (attempts >= maxAttempts) {
                                    console.warn(`‚ö†Ô∏è Supabase –Ω–µ –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
                                    console.log('–°–æ–∑–¥–∞—é –∑–∞–≥–ª—É—à–∫—É...');
                                    this.createSupabaseStub();
                                    resolve();
                                    return;
                                }

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
                                setTimeout(check, 100);
                            };

                            check();
                        });
                    },

                    // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ó–ê–ì–õ–£–®–ö–ò:
                    createSupabaseStub() {
                        console.warn('–°–æ–∑–¥–∞—é –∑–∞–≥–ª—É—à–∫—É Supabase');

                        window.supabase = {
                            from: (table) => {
                                console.log(`[–ó–ê–ì–õ–£–®–ö–ê] –ó–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ: ${table}`);
                                return {
                                    select: () => Promise.resolve({ data: [], error: null }),
                                    insert: () => Promise.resolve({ data: [], error: null }),
                                    update: () => Promise.resolve({ data: [], error: null }),
                                    delete: () => Promise.resolve({ data: [], error: null }),
                                    eq: () => ({ select: () => Promise.resolve({ data: [], error: null }) })
                                };
                            }
                        };

                        this.notificationStatus = '–†–µ–∂–∏–º –¥–µ–º–æ (–±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î)';
                    },

                    // –î–µ–º–æ —Ä–∞—Å—Ç–µ–Ω–∏—è:
                    addDemoPlants() {
                        console.log('–î–æ–±–∞–≤–ª—è—é –¥–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è...');

                        const demoPlants = [
                            {
                                id: 1,
                                custom_name: '–§–∏–∫—É—Å –≤ –≥–æ—Å—Ç–∏–Ω–æ–π',
                                species_name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞',
                                watering_days: 7,
                                days_until: 2,
                                last_watered: '2024-03-12',
                                watering_progress: 71,
                                days_passed: 5
                            },
                            {
                                id: 2,
                                custom_name: '–ö–∞–∫—Ç—É—Å –Ω–∞ –æ–∫–Ω–µ',
                                species_name: '–ö–∞–∫—Ç—É—Å',
                                watering_days: 14,
                                days_until: 0,
                                last_watered: '2024-03-01',
                                watering_progress: 100,
                                days_passed: 14
                            },
                            {
                                id: 3,
                                custom_name: '–û—Ä—Ö–∏–¥–µ—è –≤ —Å–ø–∞–ª—å–Ω–µ',
                                species_name: '–û—Ä—Ö–∏–¥–µ—è –§–∞–ª–µ–Ω–æ–ø—Å–∏—Å',
                                watering_days: 5,
                                days_until: 1,
                                last_watered: '2024-03-10',
                                watering_progress: 80,
                                days_passed: 4
                            }
                        ];

                        this.plants = demoPlants;
                        this.notificationStatus = '–î–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã!';
                        setTimeout(() => this.notificationStatus = '', 3000);

                        console.log('–î–µ–º–æ-—Ä–∞—Å—Ç–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã:', this.plants.length);
                    },

                    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    async registerUser() {
                        if (!this.user || !window.supabase) {
                            console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                            return;
                        }

                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (this.user.id === 123456789) {
                            console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                            return;
                        }

                        try {
                            console.log(`üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${this.user.id} –≤ –ë–î...`);

                            const { data, error } = await window.supabase
                                .from('users')
                                .upsert({
                                    telegram_id: this.user.id,
                                    username: this.user.username,
                                    first_name: this.user.first_name,
                                    last_name: this.user.last_name,
                                    created_at: new Date().toISOString()
                                }, {
                                    onConflict: 'telegram_id',
                                    ignoreDuplicates: true // –û–ø—Ü–∏—è –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                                });

                            if (error) {
                                console.warn('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error.message);
                                // –ù–ï –ë–†–û–°–ê–ï–ú –û–®–ò–ë–ö–£ - —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            } else {
                                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω');
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error.message);
                            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
                        }
                    },

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
                    initTelegram() {
                        console.log('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');

                        if (window.Telegram && Telegram.WebApp) {
                            console.log('Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                            Telegram.WebApp.ready();
                            Telegram.WebApp.expand();

                            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const userData = Telegram.WebApp.initDataUnsafe?.user;
                            console.log('initDataUnsafe.user:', userData);

                            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
                            const initData = Telegram.WebApp.initData;
                            console.log('initData —Å—Ç—Ä–æ–∫–∞:', initData);

                            if (userData && userData.id) {
                                this.user = {
                                    id: userData.id,
                                    username: userData.username,
                                    first_name: userData.first_name,
                                    last_name: userData.last_name
                                };
                                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —á–µ—Ä–µ–∑ initDataUnsafe:', this.user);
                            } else {
                                // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å initData
                                try {
                                    const params = new URLSearchParams(initData);
                                    const userJson = params.get('user');
                                    if (userJson) {
                                        const parsedUser = JSON.parse(decodeURIComponent(userJson));
                                        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ parsed initData:', parsedUser);

                                        if (parsedUser.id) {
                                            this.user = {
                                                id: parsedUser.id,
                                                username: parsedUser.username,
                                                first_name: parsedUser.first_name,
                                                last_name: parsedUser.last_name
                                            };
                                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —á–µ—Ä–µ–∑ parsing:', this.user);
                                        }
                                    }
                                } catch (parseError) {
                                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å initData:', parseError);
                                }

                                // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                if (!this.user || !this.user.id) {
                                    console.warn('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ Telegram WebApp');
                                    console.log('Telegram.WebApp –æ–±—ä–µ–∫—Ç:', Telegram.WebApp);
                                    console.log('Telegram –≤–µ—Ä—Å–∏—è:', Telegram.WebApp.version);

                                    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                                    this.notificationStatus = `–í–Ω–∏–º–∞–Ω–∏–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram –±–æ—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã.`;
                                    setTimeout(() => this.notificationStatus = '', 60000); //–û–∂–∏–¥–∞–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ (—Ñ–æ—Ä–º—É–ª–∞: sec * 1000)

                                    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram - –∑–∞–ø—Ä–æ—Å–∏–º ID —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    this.showUserIdPrompt();
                                }
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ –¥–µ–º–æ');
                            this.showUserIdPrompt();
                        }

                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', this.user);
                    },

                    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    showUserIdPrompt() {
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤ Telegram —ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
                        // –ù–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram –ø–æ–ª–µ–∑–Ω–æ

                        const testUserId = localStorage.getItem('test_user_id');
                        if (testUserId) {
                            this.user = {
                                id: parseInt(testUserId),
                                username: 'test_user',
                                first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                                last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                            };
                            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π ID:', this.user.id);
                        } else {
                            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                            const userId = prompt(
                                '–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID (–∏–ª–∏ –ª—é–±–æ–π —á–∏—Å–ª–æ):\n\n' +
                                '–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789\n\n' +
                                '–≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π.',
                                '123456789'
                            );

                            if (userId) {
                                localStorage.setItem('test_user_id', userId);
                                this.user = {
                                    id: parseInt(userId),
                                    username: 'test_user',
                                    first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                                    last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                                };
                                console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π ID:', this.user.id);
                            } else {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
                                this.user = {
                                    id: 123456789,
                                    username: 'demo_user',
                                    first_name: '–î–µ–º–æ',
                                    last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                                };
                                console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', this.user.id);
                            }
                        }
                    },

                    // –û–∂–∏–¥–∞–Ω–∏–µ Supabase
                    async waitForSupabase() {
                        console.log('‚è≥ –û–∂–∏–¥–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Supabase...');

                        return new Promise((resolve, reject) => {
                            let attempts = 0;
                            const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

                            const check = () => {
                                attempts++;

                                if (window.supabase && typeof window.supabase.from === 'function') {
                                    console.log(`‚úÖ Supabase –≥–æ—Ç–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ ${attempts})`);
                                    resolve();
                                    return;
                                }

                                if (attempts >= maxAttempts) {
                                    console.error(`‚ùå Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
                                    this.notificationStatus = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
                                    reject(new Error('Supabase timeout'));
                                    return;
                                }

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
                                setTimeout(check, 100);
                            };

                            check();
                        });
                    },

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
                    async initSupabase() {
                        try {
                            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
                            if (this.user) {
                                const { data, error } = await window.supabase
                                    .from('users')
                                    .upsert({
                                        telegram_id: this.user.id,
                                        username: this.user.username,
                                        first_name: this.user.first_name,
                                        last_name: this.user.last_name
                                    }, {
                                        onConflict: 'telegram_id'
                                    });

                                if (error) throw error;
                                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Supabase:', data);
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
                        }
                    },

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                    async loadData() {
                        console.log('üîÑ loadData() –≤—ã–∑–≤–∞–Ω–∞');
                        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase:', {
                            exists: !!window.supabase,
                            hasFrom: typeof window.supabase?.from,
                            from: window.supabase?.from
                        });

                        try {
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞
                            if (!window.supabase || typeof window.supabase.from !== 'function') {
                                console.error('‚ùå Supabase –Ω–µ –≥–æ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
                                return this.loadTestData();
                            }

                            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
                            console.log('üìã –ó–∞–≥—Ä—É–∂–∞—é —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫...');
                            const { data: species, error: speciesError } = await window.supabase
                                .from('plant_species')
                                .select('*')
                                .order('name');

                            if (speciesError) {
                                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:', speciesError);
                                throw speciesError;
                            }

                            this.plantSpecies = species || [];
                            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∏–¥–æ–≤: ${this.plantSpecies.length}`);

                            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            await this.loadUserPlants();

                            console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ loadData:', error);
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                            this.loadTestData();
                        }
                    },

                    // –î–û–ë–ê–í–¨–¢–ï –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–•:
                    loadTestData() {
                        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');

                        this.plantSpecies = [
                            { id: 1, name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞', watering_days: 7, description: '–¢–µ—Å—Ç' },
                            { id: 2, name: '–ö–∞–∫—Ç—É—Å', watering_days: 14, description: '–¢–µ—Å—Ç' },
                            { id: 3, name: '–û—Ä—Ö–∏–¥–µ—è', watering_days: 5, description: '–¢–µ—Å—Ç' }
                        ];

                        this.plants = [
                            {
                                id: 1,
                                custom_name: '–ú–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∏–∫—É—Å',
                                species_name: '–§–∏–∫—É—Å –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∞',
                                watering_days: 7,
                                days_until: 2,
                                last_watered: '2024-03-12',
                                watering_progress: 71,
                                days_passed: 5
                            },
                            {
                                id: 2,
                                custom_name: '–ö–∞–∫—Ç—É—Å –Ω–∞ –æ–∫–Ω–µ',
                                species_name: '–ö–∞–∫—Ç—É—Å',
                                watering_days: 14,
                                days_until: 0,
                                last_watered: '2024-03-01',
                                watering_progress: 100,
                                days_passed: 14
                            }
                        ];

                        console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    },

                    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    async loadUserPlants() {
                        console.log('üåø loadUserPlants() –∑–∞–ø—É—â–µ–Ω–∞');

                        if (!this.user || !this.user.id) {
                            console.error('‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π');
                            this.plants = [];
                            return;
                        }

                        try {
                            console.log(`üîç –ò—â—É —Ä–∞—Å—Ç–µ–Ω–∏—è –¥–ª—è user_id: ${this.user.id}`);

                            const { data, error } = await window.supabase
                                .from('plants')
                                .select(`
                *,
                plant_species(name, description)
            `)
                                .eq('user_id', this.user.id)
                                .order('next_watering');

                            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π:', {
                                data,
                                error,
                                count: data?.length
                            });

                            if (error) {
                                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π:', error);
                                throw error;
                            }

                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                            this.plants = (data || []).map(plant => {
                                const today = new Date();
                                const nextWatering = new Date(plant.next_watering);
                                const lastWatered = new Date(plant.last_watered);

                                // –†–∞–∑–Ω–∏—Ü–∞ –≤ –¥–Ω—è–º–∏
                                const diffTime = nextWatering - today;
                                const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                // –ü—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª–∏–≤–∞
                                const daysPassed = Math.floor((today - lastWatered) / (1000 * 60 * 60 * 24));
                                const wateringProgress = Math.min(100, (daysPassed / plant.watering_days) * 100);

                                return {
                                    ...plant,
                                    species_name: plant.plant_species?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∏–¥',
                                    days_until: daysUntil,
                                    days_passed: daysPassed,
                                    watering_progress: wateringProgress
                                };
                            });

                            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ç–µ–Ω–∏–π: ${this.plants.length}`);

                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ loadUserPlants():', error);
                            this.plants = [];
                        }
                    },

                    // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    get filteredPlants() {
                        if (this.filter === 'all') return this.plants;
                        if (this.filter === 'today') return this.plants.filter(p => p.days_until <= 0);
                        if (this.filter === 'tomorrow') return this.plants.filter(p => p.days_until === 1);
                        return this.plants;
                    },

                    // –í—ã–±–æ—Ä –≤–∏–¥–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    onSpeciesChange(speciesId) {
                        if (!speciesId) {
                            this.selectedSpecies = null;
                            return;
                        }

                        const species = this.plantSpecies.find(s => s.id == speciesId);
                        if (species) {
                            this.selectedSpecies = species;
                            this.newPlant.watering_days = species.watering_days || 7;
                        } else {
                            this.selectedSpecies = null;
                        }
                    },

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    addingPlant: false,
                    async addNewPlant() {
                        if (!this.user || this.addingPlant) return;

                        this.addingPlant = true;

                        try {
                            const plantData = {
                                user_id: this.user.id,
                                custom_name: this.newPlant.custom_name.trim(),
                                species_id: this.newPlant.species_id,
                                watering_days: parseInt(this.newPlant.watering_days),
                                notes: this.newPlant.notes.trim(),
                                last_watered: new Date().toISOString().split('T')[0]
                            };

                            const { data, error } = await window.supabase
                                .from('plants')
                                .insert([plantData])
                                .select();

                            if (error) throw error;

                            // –£—Å–ø–µ—à–Ω–æ
                            this.showAddForm = false;
                            await this.loadUserPlants();

                            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                            this.newPlant = {
                                custom_name: '',
                                species_id: '',
                                watering_days: 7,
                                notes: ''
                            };
                            this.selectedSpecies = null;

                            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            this.notificationStatus = '–†–∞—Å—Ç–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!';
                            setTimeout(() => this.notificationStatus = '', 3000);

                            // –ü–æ–∫–∞–∑–∞—Ç—å –≤ Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å)
                            if (window.Telegram && Telegram.WebApp) {
                                Telegram.WebApp.showAlert('–†–∞—Å—Ç–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ! –ú—ã –±—É–¥–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –ø–æ–ª–∏–≤–µ.');
                            }

                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è:', error);
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è';
                        } finally {
                            this.addingPlant = false;
                        }
                    },

                    // –ü–æ–ª–∏–≤ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    async waterPlant(plantId) {
                        try {
                            const today = new Date().toISOString().split('T')[0];

                            const { error } = await window.supabase
                                .from('plants')
                                .update({ last_watered: today })
                                .eq('id', plantId);

                            if (error) throw error;

                            // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª–∏–≤–æ–≤ (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å)
                            try {
                                await window.supabase
                                    .from('watering_history')
                                    .insert([{ plant_id: plantId }]);
                            } catch (historyError) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
                            }

                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                            await this.loadUserPlants();

                            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            const plant = this.plants.find(p => p.id === plantId);
                            if (plant) {
                                this.notificationStatus = `–†–∞—Å—Ç–µ–Ω–∏–µ "${plant.custom_name}" –ø–æ–ª–∏—Ç–æ!`;
                                setTimeout(() => this.notificationStatus = '', 3000);
                            }

                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ–ª–∏–≤–∞:', error);
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ–ª–∏–≤–∞';
                        }
                    },

                    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    async showPlantDetails(plantId) {
                        const plant = this.plants.find(p => p.id === plantId);
                        if (!plant) return;

                        this.selectedPlant = plant;

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª–∏–≤–æ–≤
                        try {
                            const { data, error } = await window.supabase
                                .from('watering_history')
                                .select('*')
                                .eq('plant_id', plantId)
                                .order('watered_date', { ascending: false })
                                .limit(10);

                            if (!error) {
                                this.wateringHistory = data;
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                        }

                        this.showDetailsModal = true;
                    },

                    // –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    async deletePlant(plantId) {
                        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                            return;
                        }

                        try {
                            const { error } = await window.supabase
                                .from('plants')
                                .delete()
                                .eq('id', plantId);

                            if (error) throw error;

                            this.showDetailsModal = false;
                            await this.loadUserPlants();

                            this.notificationStatus = '–†–∞—Å—Ç–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
                            setTimeout(() => this.notificationStatus = '', 3000);

                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è:', error);
                            this.notificationStatus = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è';
                        }
                    },

                    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
                    getWateringStatusClass(plant) {
                        if (plant.days_until <= 0) return 'bg-red-100 text-red-800';
                        if (plant.days_until === 1) return 'bg-yellow-100 text-yellow-800';
                        if (plant.days_until <= 3) return 'bg-blue-100 text-blue-800';
                        return 'bg-gray-100 text-gray-800';
                    },

                    getWateringStatusText(plant) {
                        if (plant.days_until < 0) return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!';
                        if (plant.days_until === 0) return '–ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è';
                        if (plant.days_until === 1) return '–ó–∞–≤—Ç—Ä–∞';
                        return `–ß–µ—Ä–µ–∑ ${plant.days_until} –¥–Ω.`;
                    },

                    getNextWateringText(plant) {
                        if (plant.days_until <= 0) return '–ü–æ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è!';
                        if (plant.days_until === 1) return '–ó–∞–≤—Ç—Ä–∞';
                        return `–ß–µ—Ä–µ–∑ ${plant.days_until} –¥–Ω–µ–π`;
                    },

                    getTextColor(days) {
                        if (days <= 0) return 'text-red-600';
                        if (days <= 2) return 'text-yellow-600';
                        return 'text-green-600';
                    },

                    formatDate(dateString) {
                        if (!dateString) return '‚Äî';
                        try {
                            const date = new Date(dateString);
                            if (isNaN(date.getTime())) return '‚Äî';
                            return date.toLocaleDateString('ru-RU', {
                                day: 'numeric',
                                month: 'long'
                            });
                        } catch (e) {
                            return '‚Äî';
                        }
                    }
                };
            }
        </script>
</body>

</html>